#include <windows.h>
#include <alloc.h>
#include <stdlib.h>
#include "lk.h"
#include "km.h"

extern FRAME FAR Frame;
extern char FAR FullPath[128];

/*
ﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁ
ﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁ DATA ﬁﬁﬁﬁ
ﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁﬁ
*/
/*
⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒø
≥                                                                 ≥ Register ≥
≥                                                                 ¿ƒƒƒƒƒƒƒƒƒƒ¥
¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒŸ
*/
BOOL DATA::Register ( VOID ) {

	WNDCLASS wc;

	wc.style         = CS_HREDRAW | CS_VREDRAW;
	wc.lpfnWndProc   = DataWndProc;
	wc.cbClsExtra    = 0;
	wc.cbWndExtra    = sizeof ( LPDATA );  // Ñ´Ô Â‡†≠•≠®Ô ì™†ß†‚•´Ô ≠† Æ°Í•™‚
	wc.hInstance     = Frame.hInstance;
	wc.hIcon         = LoadIcon ( Frame.hInstance, "data" );
	wc.hCursor       = 0;
	wc.hbrBackground = COLOR_APPWORKSPACE + 1;
	wc.lpszMenuName  = NULL;
	wc.lpszClassName = DATA::Name;

	if ( ! RegisterClass ( & wc ) ) {
		ErrorMessager  ( 0, MB_OK | MB_ICONHAND | MB_SYSTEMMODAL, IDS_CANTREGISTER );
		return FALSE;
		}

	return TRUE;
	}

/*
⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒø
≥ é‚™‡Î‚Ï Æ™≠Æ §†≠≠ÎÂ                                                 ≥ Open ≥
≥                                                                     ¿ƒƒƒƒƒƒ¥
¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒŸ
*/
int DATA::Open ( LPSTR Path ) {
	LPDATA tis;

	// ÇÎ§•´®‚Ï Ø†¨Ô‚Ï §´Ô Æ°Í•™‚† DATA
	tis = (LPDATA) farmalloc ( sizeof(DATA) );
	if ( tis == NULL ) {
		ErrorMessager  ( Frame.hwndFrame, MB_OK | MB_ICONHAND | MB_SYSTEMMODAL, IDS_CANTALLOC );
		return LKE_ALLOCMEM;
		}

	// à≠®Ê®†´®ß®‡Æ¢†‚Ï •£Æ ØÆ´Ô
	tis->KBase = KBASE::OpenKBase ( Path );
	if ( KBASE::Error != LKE_SUCCESS ) {
		ErrorMessager  ( Frame.hwndFrame, MB_OK | MB_ICONHAND | MB_SYSTEMMODAL, IDS_CANTALLOC );
		farfree ( tis );
		return IDS_CANTALLOC;                        // ????????????????????
		}

	// Ñ†´Ï≠•©Ë†Ô ®≠®Ê®†´®ß†Ê®Ô ØÆ´•©
	tis->SplitState = IDM_VIEWNONE;
	tis->Part       = 0.6;
	tis->CurFocus   = IDM_ATT_LISTBOX;

	MDICREATESTRUCT mcs;
	char sz[80] = TITLE_DATA;

	if ( Path ) lstrcat ( sz, GetPathName ( Path ) );
	else        lstrcat ( sz, TITLE_UNTITLED );

	mcs.szTitle = sz;

	mcs.szClass    = DATA::Name;
	mcs.hOwner     = Frame.hInstance;
    mcs.x = mcs.cx = CW_USEDEFAULT;
    mcs.y = mcs.cy = CW_USEDEFAULT;
	mcs.style      = 0;
	mcs.lParam     = (LPARAM) tis;

	// ëÆß§†‚Ï Æ·≠Æ¢≠Æ• Æ™≠Æ ·‚‡„™‚„‡Î
	tis->hWnd = (HANDLE) SendMessage ( Frame.hwndClient, WM_MDICREATE, 0, (LONG) &mcs );
	if( ! tis->hWnd ) {
		tis->Close();
		ErrorMessager ( Frame.hwndFrame, MB_OK | MB_ICONHAND | MB_SYSTEMMODAL, IDS_CANTCREATEWIN );
		return IDS_CANTCREATEWIN;
		}

	// ëÆß§†‚Ï Æ™≠Æ †‚‡®°„‚Æ¢ (ListBox)
	tis->hwndAtt = CreateWindow ( "LISTBOX", NULL,
             LBS_HASSTRINGS | LBS_OWNERDRAWFIXED | WS_CHILD | WS_VSCROLL | WS_HSCROLL | WS_BORDER | LBS_NOINTEGRALHEIGHT | LBS_NOTIFY | LBS_WANTKEYBOARDINPUT,
             CW_USEDEFAULT, 0, CW_USEDEFAULT, 0,
             tis->hWnd, IDM_ATT_LISTBOX, Frame.hInstance, NULL );

	// ëÆß§†‚Ï Æ™≠Æ ß≠†Á•≠®© (ListBox)
	tis->hwndVal = CreateWindow( "LISTBOX", NULL,
             LBS_HASSTRINGS | LBS_OWNERDRAWFIXED | WS_CHILD | WS_VSCROLL | WS_HSCROLL | WS_BORDER | LBS_NOINTEGRALHEIGHT | LBS_NOTIFY | LBS_WANTKEYBOARDINPUT,
             CW_USEDEFAULT, 0, CW_USEDEFAULT, 0,
             tis->hWnd, IDM_VAL_LISTBOX, Frame.hInstance, NULL );

	// è‡Æ®ß¢•·‚® Ø‡Æ¢•‡™„ ™Æ‡‡•™‚≠Æ·‚® Æ‚™‡Î‚®Ô ListBox'Æ¢
	if ( ! tis->hwndAtt || ! tis->hwndVal ) {
		SendMessage ( tis->hWnd, WM_CLOSE, 0, 0 );
		ErrorMessager  ( Frame.hwndFrame, MB_OK | MB_ICONHAND | MB_SYSTEMMODAL, IDS_CANTCREATEWIN );
		return IDS_CANTCREATEWIN;
		}

	// à≠®Ê®†´®ß†Ê®Ô ·Æ·‚ÆÔ≠®Ô
	tis->KBase->SetCurAtt ( -1 );
	tis->KBase->SetCurVal ( -1 );
	tis->KBase->SetAttSort ( SORT_ASINRULE );
	tis->KBase->SetValSort ( SORT_UNSORTED );
	tis->KBase->SetWindow ( tis->hWnd );
	tis->KBase->SetView ( VIEW_DATA );
	tis->KBase->SetCurRule ( 0 );

	tis->PrintOn();

	// èÆ§·‚‡Æ®‚Ï ‡†ß¨•‡Î ListBox'Æ¢
	RECT rc;
	GetClientRect ( tis->hWnd, & rc );
	tis->Size ( SIZENORMAL, MAKELONG ( rc.right, rc.bottom ) );

	ShowWindow ( tis->hWnd, SW_SHOWNORMAL );
	ShowWindow ( tis->hwndAtt, SW_SHOWNORMAL );
	ShowWindow ( tis->hwndVal, SW_SHOWNORMAL );

	tis->SetFocus();

	return LKE_SUCCESS;
	}

/*
⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒø
≥ á†™‡Î‚Ï Æ™≠Æ ß≠†≠®©. è•‡•§ ß†™‡Î‚®•¨ ≠•Æ°ÂÆ§®¨Æ Ø‡Æ¢•‡®‚Ï          ≥ Close ≥
≥ ¨Æ¶≠Æ ´® Ì‚Æ §•´†‚Ï. Ö·´® ß†™‡Î‚Æ, ‚Æ ¢Æß¢‡†È†•‚·Ô TRUE.           ¿ƒƒƒƒƒƒƒ¥
¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒŸ
*/
BOOL DATA::Close ( VOID ) {

	if ( 1 == KBase->KBaseNumber() ) {             // ù‚Æ ØÆ·´•§≠•• Æ™≠Æ ‰†©´†
		if ( ! KBase->isKBaseSaved() ) {     // ® •·´® ·Æ§•‡¶®¨Æ• ≠• ·ÆÂ‡†≠•≠Æ
			// ‚Æ ß†Ø‡Æ·®‚Ï ØÆ´ÏßÆ¢†‚•´Ô Æ ·ÆÂ‡†≠•≠®®/≠•·ÆÂ‡†≠•≠®®/Æ‚¨•≠•
			char szName[20];
			int Answ;
			lstrcpy ( szName, KBase->GetNamePtr() );     // èÆ´„Á®‚Ï ®¨Ô ‰†©´†
			if ( szName[0] == 0 ) lstrcpy ( szName, TITLE_UNTITLED );
			Answ = ErrorMessager  ( Frame.hwndFrame, MB_YESNOCANCEL | MB_APPLMODAL | MB_ICONEXCLAMATION, IDS_CLOSESAVE, szName );
			switch ( Answ ) {
				case IDYES :                         // ëÆÂ‡†≠®‚Ï Åá ® ß†™‡Î‚Ï
					if ( ! Save () ) return FALSE;
					break;
				case IDNO :                          // á†™‡Î‚Ï °•ß ·ÆÂ‡†≠•≠®Ô
					break;
				default   :
					// ã®°Æ ÆË®°™† MessageBox(), ´®°Æ Æ‚™†ß Æ‚ ß†™‡Î‚®Ô
					return FALSE;
				}
			}
		}

	// ó‚Æ°Î ™ Æ™≠„ ≠• Ø‡®ÂÆ§®´Æ ·ÆÆ°È•≠®©, ØÆ·´• „§†´•≠®Ô Æ°Í•™‚†
	DestroyWindow ( hwndAtt );
	DestroyWindow ( hwndVal );

	// á†™‡Î‚Ï Æ°Í•™‚ KBASE
	KBase->CloseKBase();

	return TRUE;
	}

/*
⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒø
≥ ëÆÂ‡†≠®‚Ï ·Æ§•‡¶®¨Æ• Åá. Ö·´® ≠•®¨•≠Æ¢†≠† Åá, ‚Æ ¢Îß¢†‚Ï §®†´Æ£     ≥ Save ≥
≥ SaveAs. Ö·´® Åá ·ÆÂ‡†≠•≠†, ‚Æ ¢•‡≠„‚Ï TRUE.                         ¿ƒƒƒƒƒƒ¥
¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒŸ
*/
BOOL DATA::Save ( VOID ) {

	if ( KBase->isKBaseNamed() ) {                          // ë‡†ß„ ·ÆÂ‡†≠®‚Ï
#ifdef EDIPDEMO
		ErrorMessager  ( 0, MB_OK | MB_ICONHAND, IDS_EDIPDEMO );
#else
		if ( LKE_SUCCESS != KBase->SaveKBase() ) {
			ErrorMessager  ( 0, MB_OK | MB_ICONHAND | MB_SYSTEMMODAL, IDS_CANTSAVE );
			return FALSE;
			}
#endif
		}
	else if ( FileSaveAs() ) {               // ëÆÂ‡†≠®‚Ï ØÆ·´• Ø•‡•®¨•≠Æ¢†≠®Ô
		KBase->RenameKBase ( FullPath );
#ifdef EDIPDEMO
		ErrorMessager  ( 0, MB_OK | MB_ICONHAND, IDS_EDIPDEMO );
#else
		if ( LKE_SUCCESS != KBase->SaveKBase() ) {
			ErrorMessager  ( 0, MB_OK | MB_ICONHAND | MB_SYSTEMMODAL, IDS_CANTSAVE );
			return FALSE;
			}
#endif
		}
	else return FALSE;                             // é‚™†ß (Cancel) ¢ §®†´Æ£•

	return TRUE;
	}

/*
⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒø
≥                                                                     ≥ Size ≥
≥                                                                     ¿ƒƒƒƒƒƒ¥
¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒŸ
*/
VOID DATA::Size ( WPARAM wParam, LPARAM lParam ) {

	if ( wParam != SIZENORMAL && wParam != SIZEFULLSCREEN ) return;

	ShowWindow ( hwndAtt, SW_HIDE );
	ShowWindow ( hwndVal, SW_HIDE );

	if ( SplitState == IDM_VIEWHORIZONTAL ) {
		int AttHight = (int) ( HIWORD(lParam) * Part     ) + 1;
		int ValHight = (int) ( HIWORD(lParam) * (1-Part) ) - Frame.BrdWidth + 2;

		MoveWindow ( hwndAtt, -1, -1,                            LOWORD(lParam) + 2, AttHight, 1 );
		MoveWindow ( hwndVal, -1, AttHight + Frame.BrdWidth - 1, LOWORD(lParam) + 2, ValHight, 1 );
		ShowWindow ( hwndAtt, SW_SHOWNOACTIVATE );
		ShowWindow ( hwndVal, SW_SHOWNOACTIVATE );
		}

	else if ( SplitState == IDM_VIEWVERTICAL ) {
		int AttWidth = (int) ( LOWORD(lParam) * Part     ) + 1;
		int ValWidth = (int) ( LOWORD(lParam) * (1-Part) ) - Frame.BrdWidth + 2;

		MoveWindow ( hwndAtt, -1,                            -1, AttWidth, HIWORD(lParam) + 2, 1 );
		MoveWindow ( hwndVal, AttWidth + Frame.BrdWidth - 1, -1, ValWidth, HIWORD(lParam) + 2, 1 );
		ShowWindow ( hwndAtt, SW_SHOWNOACTIVATE );
		ShowWindow ( hwndVal, SW_SHOWNOACTIVATE );
		}
	else {
		MoveWindow ( hwndAtt, -1, -1, LOWORD(lParam) + 2, HIWORD(lParam) + 2, 1 );
		ShowWindow ( hwndAtt, SW_SHOWNOACTIVATE );
		}
	SetFocus ( );
	}

/*
⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒø
≥                                                                     ≥ View ≥
≥                                                                     ¿ƒƒƒƒƒƒ¥
¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒŸ
*/
VOID DATA::View ( int NewView ) {
	RECT rc;
	GetClientRect ( hWnd, & rc );
	int Prev = SplitState;

	// ì·‚†≠Æ¢®‚Ï ≠Æ¢Î© ¢®§
	if ( ( NewView == IDM_VIEWHORIZONTAL && Prev == IDM_VIEWHORIZONTAL ) ||
         ( NewView == IDM_VIEWVERTICAL   && Prev == IDM_VIEWVERTICAL ) )
		SplitState = IDM_VIEWNONE;
	else
		SplitState = NewView;

	if ( SplitState == IDM_VIEWNONE ) {
		// á†ØÆ´≠®‚Ï Æ™≠† ≠Æ¢Î¨ ·Æ§•‡¶®¨Î¨
		// ¢ Æ§≠ÆÆ™Æ≠≠Æ¨ ‡•¶®¨• · ·ÆÂ‡†≠•≠®•¨ ‚•™„È®Â Ø†‡†¨•‚‡Æ¢
		CurFocus = IDM_ATT_LISTBOX;
		FillNoneView();
		}

	if ( Prev == IDM_VIEWNONE ) {
		// á†ØÆ´≠®‚Ï Æ™≠† ≠Æ¢Î¨ ·Æ§•‡¶®¨Î¨
		// ¢ §¢„Æ™Æ≠≠Î¨ ‡•¶®¨• · ·ÆÂ‡†≠•≠®•¨ ‚•™„È®Â Ø†‡†¨•‚‡Æ¢
        FillAttListBox();
		FillValListBox ( KBase->GetCurAtt() );
		}

	if ( SplitState == IDM_VIEWHORIZONTAL )
		SetClassWord ( hWnd, GCW_HCURSOR, HorCur );
	else
		SetClassWord ( hWnd, GCW_HCURSOR, VerCur );

	if ( Prev == IDM_VIEWNONE ) {
		ShowWindow ( hwndVal, SW_SHOWNOACTIVATE );   // èÆ™†ß†‚Ï Æ™≠Æ ß≠†Á•≠®©
		}
	if ( SplitState == IDM_VIEWNONE ) {
		ShowWindow ( hwndVal, SW_HIDE );                   // ë™‡Î‚Ï Æ§≠Æ Æ™≠Æ
		}

	Size ( SIZENORMAL, MAKELONG ( rc.right, rc.bottom ) );

//	PrintOn ( );
//	CurFocus = IDM_ATT_LISTBOX;
//	SetFocus ( );

	}

/*
⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒø
≥                                                                 ≥ PartMove ≥
≥                                                                 ¿ƒƒƒƒƒƒƒƒƒƒ¥
¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒŸ
*/
VOID DATA::PartMove ( UINT msg, LPARAM lParam ) {
/*
éØ‡•§•´®‚Ï ‚•™„È®© ‡†ß¨•‡ (¢Î·Æ‚† ®´® Ë®‡®≠†) Æ™≠† †‚‡®°„‚Æ¢ ®
ß†ØÆ¨≠®‚Ï •£Æ ¢¨•·‚• ≠†Á†´Ï≠Î¨® ™ÆÆ‡§®≠†‚†¨® ¨ÎË®. è‡® §¢®¶•≠®®
¨ÎË® ÆØ‡•§•´Ô‚Ï ·¨•È•≠®• Æ‚≠Æ·®‚•´Ï≠Æ ≠†Á†´Ï≠Æ© ™ÆÆ‡§®≠†‚Î ®
·ÆÆ‚¢•‚·‚¢•≠≠Æ ®ß¨•≠Ô‚Ï ‡†ß¨•‡ Æ™≠† †‚‡®°„‚Æ¢. èÆ·™Æ´Ï™„ §®†Ø†ßÆ≠
®ß¨•≠•≠®Ô Æ™≠† †‚‡®°„‚Æ¢ ¢·•£§† ®ß¢•·‚•≠ (¨•¶§„ 0 ® ‡†ß¨•‡Æ¨ Ø†ØÎ
°•ß Ë®‡®≠Î °Æ‡§Ó‡†), ‚Æ ≠•Æ°ÂÆ§®¨Æ §•‡¶†‚Ï •£Æ ¢ Ì‚Æ¨ §®†Ø†ßÆ≠•.
è•‡•‡®·Æ¢Î¢†≠®• ØÆ´Æ·Î Ø‡Æ®·ÂÆ§®‚ ®·ÂÆ§Ô ®ß ‚•™„È•£Æ ‡†ß¨•‡† Æ™≠†
†‚‡®°„‚Æ¢. è‡® Æ‚Ø„·™†≠®® ¨ÎË®, ØÆ´• Part ≠†ÂÆ§®‚·Ô ™†™ Æ‚≠ÆË•≠®•
‡†ß¨•‡Æ¢ Æ™≠† †‚‡®°„‚Æ¢ ® Ø†ØÎ.

í†™®¨ Æ°‡†ßÆ¨, Æ·≠Æ¢≠†Ô Ø•‡•¨•≠≠†Ô Ì‚Æ ‚•™„È®© ‡†ß¨•‡ Æ™≠†
†‚‡®°„‚Æ¢, Æ≠† Æ‚‡†¶†•‚ ØÆ´Æ¶•≠®• ØÆ´Æ·Î. Ö• ≠†Á†´Ï≠Æ• ·Æ·‚ÆÔ≠®•
ÆØ‡•§•´Ô•‚·Ô Ø‡® Ø•‡¢Æ¨ ≠†¶†‚®® ¨ÎË® (≠•ß†¢®·®¨Æ Æ‚ ¨•·‚† ≠†¶†‚®Ô
¢≠„‚‡® ØÆ´Æ·Î, Á‚Æ ÂÆ‡ÆËÆ) ®·ÂÆ§Ô ®ß ‚•™„È•£Æ Part ® ‡†ß¨•‡Æ¢
Ø†ØÎ (·¨. ‰„≠™Ê®Ó Size). àß¨•≠•≠®• Ì‚Æ© Ø•‡•¨•≠≠Æ© Ø‡Æ®·ÂÆ§®‚
Ø„‚•¨ §Æ°†¢´•≠®Ô ™ ≠•© ‚•™„È•£Æ ·¨•È•≠®Ô ¨ÎË® Æ‚≠Æ·®‚•´Ï≠Æ
≠†Á†´Ï≠Æ£Æ ØÆ´Æ¶•≠®Ô. é‚·Ó§† ·´•§„•‚, Á‚Æ ¢ ¨Æ¨•≠‚ ≠†¶†‚®Ô ¨ÎË®
≠•Æ°ÂÆ§®¨Æ ß†ØÆ¨≠®‚Ï ™ÆÆ‡§®≠†‚„.
*/

	static BOOL isMove;
	static int AttSizeStart;
	static int AttSize;
	static int StartPos;
	static RECT rc;

	if ( msg == WM_LBUTTONDOWN ) {
		isMove = TRUE;
		SetCapture ( hWnd );
		GetClientRect ( hWnd, & rc );
		if ( SplitState == IDM_VIEWHORIZONTAL ) {
			AttSizeStart = AttSize = (int) ( rc.bottom * Part ) + 1; // ÇÎ·Æ‚†
			StartPos = HIWORD ( lParam );
			DrawPart ( AttSize, IDM_VIEWHORIZONTAL );
			}
		else if ( SplitState == IDM_VIEWVERTICAL ) {
			AttSizeStart = AttSize = (int) ( rc.right * Part ) + 1;  // ò®‡®≠†
			StartPos = LOWORD ( lParam );
			DrawPart ( AttSize, IDM_VIEWVERTICAL );
			}
		}
	else if ( msg == WM_MOUSEMOVE && isMove) {
		// è•‡•‡®·Æ¢†‚Ï ØÆ´Æ·„ •·´® ®ß¨•≠•≠®• ¢ ≠„¶≠Æ¨ ≠†Ø‡†¢´•≠®®
		if ( SplitState == IDM_VIEWHORIZONTAL ) {
			DrawPart ( AttSize, IDM_VIEWHORIZONTAL );
			AttSize = AttSizeStart + HIWORD(lParam) - StartPos;
			if ( AttSize < 1 ) AttSize = 1;
			if ( AttSize > rc.bottom - Frame.BrdWidth + 1 ) AttSize = rc.bottom - Frame.BrdWidth + 1;
			DrawPart ( AttSize, IDM_VIEWHORIZONTAL );
			}
		else if ( SplitState == IDM_VIEWVERTICAL ) {
			DrawPart ( AttSize, IDM_VIEWVERTICAL );
			AttSize = AttSizeStart + LOWORD(lParam) - StartPos;
			if ( AttSize < 1 ) AttSize = 1;
			if ( AttSize > rc.right - Frame.BrdWidth + 1 ) AttSize = rc.right - Frame.BrdWidth + 1;
			DrawPart ( AttSize, IDM_VIEWVERTICAL );
			}
		}
	else if ( msg == WM_LBUTTONUP && isMove ) {
		// ÇÎÁ®·´®‚Ï ≠Æ¢Æ• ß≠†Á•≠®• Part ® ØÆ·´†‚Ï ·ÆÆ°È•≠®• WM_SIZE
		if ( SplitState == IDM_VIEWHORIZONTAL ) {
			Part = (float) (AttSize - 1) / (float) ( rc.bottom );
			DrawPart ( AttSize, IDM_VIEWHORIZONTAL );
			}
		else if ( SplitState == IDM_VIEWVERTICAL ) {
			Part = (float) (AttSize - 1) / (float) ( rc.right );
			DrawPart ( AttSize, IDM_VIEWVERTICAL );
			}
		isMove = FALSE;
		ReleaseCapture ( );
		Size ( SIZENORMAL, MAKELONG ( rc.right, rc.bottom ) );

		}
	}

/*
⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒø
≥                                                                 ≥ DrawPart ≥
≥                                                                 ¿ƒƒƒƒƒƒƒƒƒƒ¥
¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒŸ
*/
VOID DATA::DrawPart ( int AttSize, WORD vh ) {
	RECT rc;
	GetClientRect ( hWnd, & rc );

	if ( vh == IDM_VIEWHORIZONTAL ) {
		rc.top = AttSize-1;    rc.bottom = AttSize + Frame.BrdWidth - 1;
		}
	if ( vh == IDM_VIEWVERTICAL ) {
		rc.left = AttSize-1;   rc.right = AttSize + Frame.BrdWidth - 1;
		}

	HDC hdc = GetDC ( hWnd );

	InvertRect ( hdc, & rc );

	ReleaseDC ( hWnd, hdc );
	}

/*
⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒø
≥ ì·‚†≠†¢´®¢†•‚ ‰Æ™„· ¢ ß†¢®·®¨Æ·‚® Æ‚ ‚•™„È•£Æ ·Æ·‚ÆÔ≠®Ô.        ≥ SetFocus ≥
≥                                                                 ¿ƒƒƒƒƒƒƒƒƒƒ¥
¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒŸ
*/
VOID DATA::SetFocus ( VOID ) {
	if ( ( SplitState == IDM_VIEWNONE ) || ( CurFocus == IDM_ATT_LISTBOX ) )
		::SetFocus ( hwndAtt );
	else ::SetFocus ( hwndVal );
	}

/*
⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø
≥ è‡•¶§• ¢·•£Æ Ì‚† ‰„≠™Ê®Ô ÆÁ®È†•‚ Æ™≠Æ Ø‡®ß≠†™Æ¢. á†‚•¨    ≥ FillAttListBox ≥
≥ Æ≠† ¢Î°®‡†•‚ ¢ ÆØ‡•§•´•≠≠Æ¨ ØÆ‡Ô§™• (ß†¢®·®‚ Æ‚ ‚•™„È•©   ¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥
≥ ·Æ‡‚®‡Æ¢™®, ™Æ‚Æ‡†Ô §Æ´¶≠† °Î‚Ï „¶• Ø‡Æ¢•§•≠†) Ø‡®ß≠†™® ®ß ‰†©´† ®         ≥
≥ ß†ØÆ´≠Ô•‚ ®¨® Æ™≠Æ (ListBox). èÆ·´•§≠ÔÔ ·‚‡Æ™† ¢ ListBox'• Ø„·‚†Ô ®        ≥
≥ Ø‡•§≠†ß≠†Á•≠† §´Ô §Æ°†¢´•≠®Ô Ø‡®ß≠†™Æ¢ ¢ ™Æ≠•Ê ·Ø®·™†. Ç ™Æ≠Ê• „·‚†≠†-     ≥
≥ ¢´®¢†•‚·Ô ‚•™„È®© ≠Æ¨•‡ †‚‡®°„‚† ® Ø•‡•¢Æ§®‚·Ô ™„‡·Æ‡. èÆ ¨•‡• ß†ØÆ´≠•≠®Ô  ≥
≥ Æ™≠† ·‚‡Æ™†¨®, ØÆ§·Á®‚Î¢†•‚·Ô ®Â ¨†™·®¨†´Ï≠†Ô §´®≠† (¢ Ø®™·•´†Â), ØÆ·´•    ≥
≥ Á•£Æ „·‚†≠†¢´®¢†•‚·Ô Ë®‡®≠† ListBox'†.                                     ≥
¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒŸ
*/
VOID DATA::FillAttListBox ( VOID ) {
	int i, w, maxWidth = 0;

//	ShowWindow ( hwndAtt, SW_HIDE );
	SendMessage ( hwndAtt, WM_SETREDRAW, FALSE, 0L );
	SendMessage ( hwndAtt, LB_RESETCONTENT, 0, 0 );        // éÁ®·‚®‚Ï ListBox

	int n = KBase->PropNumber();
	HDC hDC = GetDC ( hwndAtt );              // Ñ´Ô ÆØ‡•§•´•≠®Ô Ë®‡®≠Î ·‚‡Æ™®
	for ( i = 0; i < n; i++ ) {                       // ñ®™´ ØÆ ¢Î·™†ßÎ¢†≠®Ô¨
		ATT_REC  AttRec;

		KBase->GetAttribute ( KBase->Prop2Att ( i ), & AttRec );
		// ÇÎÁ®·´®‚Ï Ë®‡®≠„ •£Æ ≠†ß¢†≠®Ô ® ·‡†¢≠®‚Ï · ‚•™„È•© (•·´® °Æ´ÏË•, ‚Æ ·§•´†‚Ï ‚•™„È•©)
		w = LOWORD ( GetTextExtent ( hDC, (LPSTR) & AttRec.Name, lstrlen ( (LPSTR) & AttRec.Name) ) );
		if ( maxWidth < w ) maxWidth = w;

		// á†≠•·‚® †‚‡®°„‚ ¢ ListBox
		SendMessage ( hwndAtt, LB_ADDSTRING, 0, (DWORD) & AttRec.Name );
		}
	ReleaseDC ( hwndAtt, hDC );

	SendMessage ( hwndAtt, LB_ADDSTRING, 0, (DWORD)"" );
	SendMessage ( hwndAtt, LB_SETCURSEL, KBase->GetCurAttPos(), 0 );
	SendMessage ( hwndAtt, LB_SETHORIZONTALEXTENT, maxWidth+6+3*BMPWIDTH, 0 );
	SendMessage ( hwndAtt, WM_SETREDRAW, TRUE, 0L );
	InvalidateRect ( hwndAtt, NULL, FALSE );
//	ShowWindow ( hwndAtt, SW_SHOW );
	}

/*
⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø
≥ á†ØÆ´≠Ô•‚ Æ™≠Æ ß≠†Á•≠®© ·‚‡Æ™†¨®. ç•´ÏßÔ ®·ØÆ´ÏßÆ¢†‚Ï ¢   ≥ FillValListBox ≥
≥ Æ§≠ÆÆ™Æ≠≠Æ¨ ‡•¶®¨•. í•™„È•• ß≠†Á•≠®• §Æ´¶≠Æ °Î‚Ï          ¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥
≥ Ø‡†¢®´Ï≠Æ „·‚†≠Æ¢´•≠Æ. Ç·ØÆ¨Æ£†‚•´Ï≠†Ô ·‚‡Æ™† ≠• ¢¢Æ§®‚·Ô.                 ≥
¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒŸ
*/
VOID DATA::FillValListBox ( int Att ) {
	VAL_REC  ValRec;
	int j, w, maxWidth = 0;

//	ShowWindow ( hwndVal, SW_HIDE );
	SendMessage ( hwndVal, WM_SETREDRAW, FALSE, 0L );
	SendMessage ( hwndVal, LB_RESETCONTENT, 0, 0 );        // éÁ®·‚®‚Ï ListBox

	if ( Att < 0 || Att >= KBase->AttNumber() ) {
		SendMessage ( hwndVal, LB_SETHORIZONTALEXTENT, 0, 0 );
		SendMessage ( hwndVal, WM_SETREDRAW, TRUE, 0L );
		InvalidateRect ( hwndVal, NULL, FALSE );
		return;
		}

	HDC hDC = GetDC ( hwndVal );              // Ñ´Ô ÆØ‡•§•´•≠®Ô Ë®‡®≠Î ·‚‡Æ™®
	for ( j = 0; j < KBase->ValNumber ( Att ); j++ ) {    // ñ®™´ ØÆ ß≠†Á•≠®Ô¨
		// ç†©‚® ß≠†Á•≠®• · ®≠§•™·Æ¨ i ¢ ß†¢®·®¨Æ·‚® Æ‚ ‚•™„È•© ·Æ‡‚®‡Æ¢™®
        KBase->GetValue ( Att, j, & ValRec );

		// ÇÎÁ®·´®‚Ï Ë®‡®≠„ •£Æ ≠†ß¢†≠®Ô ® ·‡†¢≠®‚Ï · ‚•™„È•© (•·´® °Æ´ÏË•, ‚Æ ·§•´†‚Ï ‚•™„È•©)
		w = LOWORD ( GetTextExtent ( hDC, (LPSTR) & ValRec.Name, lstrlen ( (LPSTR) & ValRec.Name) ) );
		if ( maxWidth < w ) maxWidth = w;

		// á†≠•·‚® ß≠†Á•≠®• ¢ ListBox, † ®≠§•™· ß†Ø®·†‚Ï (Æ≠ §Æ´¶•≠ °Î‚Ï ‡†¢•≠ ®·ÂÆ§≠Æ¨„)
		SendMessage ( hwndVal, LB_ADDSTRING, 0, (DWORD) & ValRec.Name );

		}
	ReleaseDC ( hwndVal, hDC );

	SendMessage ( hwndVal, LB_SETCURSEL, KBase->GetCurVal(), 0 );

	SendMessage ( hwndVal, LB_SETHORIZONTALEXTENT, maxWidth + 6 + 3*BMPWIDTH + COMPLENGTH, 0 );
	SendMessage ( hwndVal, WM_SETREDRAW, TRUE, 0L );
	InvalidateRect ( hwndVal, NULL, FALSE );
//	ShowWindow ( hwndVal, SW_SHOW );
	}

/*
⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒø
≥ á†ØÆ´≠Ô•‚ Æ™≠Æ †‚‡®°„‚†¨® ® ß≠†Á•≠®Ô¨®.                     ≥ FillNoneView ≥
≥ í•™„È®• †‚‡®°„‚ ® ß≠†Á•≠®• §Æ´¶≠Î °Î‚Ï Ø‡†¢®´Ï≠Æ „·‚†≠Æ¢´•≠Î¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥
¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒŸ
*/
VOID DATA::FillNoneView ( VOID ) {
	int i, j, w, n, maxWidth = 0;
	ATT_REC  AttRec;
	VAL_REC  ValRec;

//	ShowWindow ( hwndAtt, SW_HIDE );
	SendMessage ( hwndAtt, WM_SETREDRAW, FALSE, 0L );
	SendMessage ( hwndAtt, LB_RESETCONTENT, 0, 0 );        // éÁ®·‚®‚Ï ListBox

	n = KBase->PropNumber();
	HDC hDC = GetDC ( hwndAtt );              // Ñ´Ô ÆØ‡•§•´•≠®Ô Ë®‡®≠Î ·‚‡Æ™®
	for ( i = 0; i < n; i++ ) {                       // ñ®™´ ØÆ ¢Î·™†ßÎ¢†≠®Ô¨

		int p = KBase->Prop2Att ( i );
		KBase->GetAttribute ( p, & AttRec );
		// ÇÎÁ®·´®‚Ï Ë®‡®≠„ •£Æ ≠†ß¢†≠®Ô ® ·‡†¢≠®‚Ï · ‚•™„È•© (•·´® °Æ´ÏË•, ‚Æ ·§•´†‚Ï ‚•™„È•©)
		w = LOWORD ( GetTextExtent ( hDC, (LPSTR) & AttRec.Name, lstrlen ( (LPSTR) & AttRec.Name) ) );
		if ( maxWidth < w ) maxWidth = w;

		// á†≠•·‚® †‚‡®°„‚ ¢ ListBox
		SendMessage ( hwndAtt, LB_ADDSTRING, 0, (DWORD) & AttRec.Name );

		for ( j = 0; j < KBase->ValNumber ( p ); j++ ) {  // ñ®™´ ØÆ ß≠†Á•≠®Ô¨

			KBase->GetValue ( p, j, & ValRec );
			// ÇÎÁ®·´®‚Ï Ë®‡®≠„ •£Æ ≠†ß¢†≠®Ô ® ·‡†¢≠®‚Ï · ‚•™„È•© (•·´® °Æ´ÏË•, ‚Æ ·§•´†‚Ï ‚•™„È•©)
			w = LOWORD ( GetTextExtent ( hDC, (LPSTR) & ValRec.Name, lstrlen ( (LPSTR) & ValRec.Name) ) );
			if ( maxWidth < w ) maxWidth = w;

			// á†≠•·‚® ß≠†Á•≠®• ¢ ListBox
			SendMessage ( hwndAtt, LB_ADDSTRING, 0, (DWORD) & ValRec.Name );
			}

		}
	ReleaseDC ( hwndAtt, hDC );

	SendMessage ( hwndAtt, LB_ADDSTRING, 0, (DWORD)"" );
	SendMessage ( hwndAtt, LB_SETCURSEL, MakeNoneIdx ( KBase->GetCurAtt(), KBase->GetCurVal() ), 0 );
	SendMessage ( hwndAtt, LB_SETHORIZONTALEXTENT, maxWidth+6+5*BMPWIDTH+COMPLENGTH, 0 );
	SendMessage ( hwndAtt, WM_SETREDRAW, TRUE, 0L );
	InvalidateRect ( hwndAtt, NULL, FALSE );
//	ShowWindow ( hwndAtt, SW_SHOW );
	}

/*
⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒø
≥ ÇÎ¢Æ§®‚ ·Æ§•‡¶®¨Æ• Æ°Í•™‚† ¢ Æ™≠Æ                                ≥ PrintOn ≥
≥                                                                  ¿ƒƒƒƒƒƒƒƒƒ¥
¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒŸ
*/
VOID DATA::PrintOn ( VOID ) {
	if ( SplitState == IDM_VIEWNONE ) FillNoneView ( );
	else {
		FillAttListBox ( );
		FillValListBox ( KBase->GetCurAtt() );
		}
	}

/*
⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒø
≥ éØ‡•§•´®‚Ï ØÆ´Æ¶•≠®• ¢ §•‡•¢• ØÆ †‚‡®°„‚„ ® ß≠†Á•≠®Ó         ≥ MakeNoneIdx ≥
≥                                                              ¿ƒƒƒƒƒƒƒƒƒƒƒƒƒ¥
¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒŸ
*/
int DATA::MakeNoneIdx ( int Att, int Val ) {
	if ( Att == -1 ) return -1;
	return ( KBase->Att2Prop ( Att ) + KBase->ValPosSum ( Att ) + Val + 1 );
	}

/*
⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒø
≥ éØ‡•§•´®‚Ï ≠Æ¨•‡ †‚‡®°„‚† ØÆ ØÆ´Æ¶•≠®Ó ¢ §•‡•¢•              ≥ NoneIdx2Att ≥
≥                                                              ¿ƒƒƒƒƒƒƒƒƒƒƒƒƒ¥
¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒŸ
*/
int DATA::NoneIdx2Att ( int Idx ) {
	if ( Idx == -1 ) return -1;

	int i, n = KBase->PropNumber();
	// ñ®™´ ØÆ ¢Î·™†ßÎ¢†≠®Ô¨
	// ÇÎÁ®·´Ô•¨ ®≠§•™· ØÆ·´•§Æ¢†‚•´Ï≠Æ §´Ô ¢·•Â ¢Î·™†ßÎ¢†≠®© ® Æ·‚†≠†¢´®¢†•¨·Ô
	// ™Æ£§† Ø•‡•¢†´®¨ ß† ß†§†≠≠Î© ®≠§•™· Idx
	for ( i = 1; i <= n; i++ ) if ( MakeNoneIdx ( KBase->Prop2Att ( i ), -1 ) > Idx ) break;

	return KBase->Prop2Att ( i - 1 );
	}

/*
⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒø
≥ éØ‡•§•´®‚Ï ≠Æ¨•‡ ß≠†Á•≠®Ô ØÆ ØÆ´Æ¶•≠®Ó ¢ §•‡•¢•              ≥ NoneIdx2Val ≥
≥                                                              ¿ƒƒƒƒƒƒƒƒƒƒƒƒƒ¥
¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒŸ
*/
int DATA::NoneIdx2Val ( int Idx ) {
	if ( Idx == -1 ) return -1;

	return ( Idx - 1 - MakeNoneIdx ( NoneIdx2Att ( Idx ), -1 ) );
	}

/*
⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø
≥ Ç·‚†¢®‚Ï ≠Æ¢Æ• ¢Î·™†ßÎ¢†≠®• ®ß ®¨•ÓÈ®Â·Ô ¢ Ø‡†¢®´Æ.    ≥ InsertProposition ≥
≥                                                        ¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥
¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒŸ
*/
VOID DATA::InsertProposition ( VOID ) {

	if ( KBase->GetCurAtt() < 0 ) return;

	// ÇÎß¢†‚Ï §®†´Æ£Æ¢ÆÓ Ø‡ÆÊ•§„‡„ ® Ø•‡•§†‚Ï •© „™†ß†‚•´Ï ≠† Æ°Í•™‚
	FARPROC lpPropProc = MakeProcInstance ( (FARPROC) DataProposProc, Frame.hInstance );
	int i = DialogBoxParam ( Frame.hInstance, "proposit", Frame.hwndFrame, lpPropProc, (DWORD) this );
	FreeProcInstance ( lpPropProc );
	if ( i == -1 ) return;                              // Ñ®†´Æ£ ≠• ·Æ·‚ÆÔ´·Ô

	// è‡Æ®ß¢•·‚® §Æ°†¢´•≠®• †‚‚‡®°„‚†.
	int Ret = KBase->InsProp ( i );

	if ( Ret == LKE_ALLOCMEM ) {
		ErrorMessager  ( 0, MB_OK | MB_ICONHAND | MB_SYSTEMMODAL, IDS_CANTALLOC );
		return;
		}

	// àß-ß† ‚Æ£Æ, Á‚Æ InsProp ¢ ™Æ≠ÍÓ≠™‚®¢≠Æ• Ø‡†¢®´Æ ¢·‚†¢´Ô•‚ §®ßÍÓ≠™‚®¢≠Î•
	// ¢Î·™†ßÎ¢†≠®Ô, † ≠†¨ ≠„¶≠Î ™Æ≠ÍÓ≠™‚®¢≠Î• ¢Î·™†ßÎ¢†≠®Ô ¢ ™Æ≠ÍÓ≠™‚®¢≠Æ¨ ¶•
	// Ø‡†¢®´•
	KBase->InvertProp ( i );
	// èÆ´„Á®´® ™Æ≠ÍÓ≠™‚®¢≠Æ• ¢Î·™†ßÎ¢†≠®• (ß†™´ÓÁ•≠®•)

	// ì·‚†≠Æ¢®‚Ï Ø†‡†¨•‚‡Î ¢Î·™†ßÎ¢†≠®Ô (≠•ß†¢®·®¨Æ ≠® Æ‚ Á•£Æ ™Æ≠ÍÓ≠™‚®¢≠Æ)
	if ( FullPath[0] == IDD_PREMISE ) KBase->InvertProp ( i );

	PrintOn();
	return;
	}

/*
⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒø
≥ ì¢•´®Á®‚Ï ™Æ¨ØÆ≠•≠‚„, ·ÆÆ‚¢•‚·‚¢„ÓÈ„Ó ß≠†Á•≠®Ó.              ≥ InsertValue ≥
≥                                                              ¿ƒƒƒƒƒƒƒƒƒƒƒƒƒ¥
¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒŸ
*/
VOID DATA::InsertValue ( VOID ) {
	if ( ( KBase->GetCurVal() < 0 ) || ( KBase->GetCurAtt() < 0 ) ||
         ( KBase->GetCurAtt() >= KBase->AttNumber() ) )
		return;

	if ( SplitState != IDM_VIEWNONE && CurFocus == hwndAtt ) return;

	COMP Comp;
	RECT rc;
	HWND hwnd;
	int Att = KBase->GetCurAtt();
	int Val = KBase->GetCurVal();

	if ( Val == -1 ) return;

	KBase->GetComp ( Att, Val, & Comp );
	if ( Comp.pos != UNITY )  Comp.pos = UNITY;
	else                      return;
	KBase->SetComp ( Att, Val, & Comp );

	if ( SplitState == IDM_VIEWNONE )  hwnd = hwndAtt;
	else                               hwnd = hwndVal;
	SendMessage ( hwnd, LB_GETITEMRECT, SendMessage ( hwnd, LB_GETCURSEL, 0, 0L ), (DWORD) & rc );
	if ( SplitState != IDM_VIEWNONE )
		rc.left = 3 * BMPWIDTH + 3;
	else
		rc.left = 5 * BMPWIDTH + 3;
	rc.right = rc.left + COMPLENGTH;
	InvalidateRect ( hwnd, & rc, TRUE );

	return;
	}

/*
⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø
≥ à≠¢•‡‚®‡Æ¢†‚Ï ¢Î·™†ßÎ¢†≠®•.                            ≥ InvertProposition ≥
≥                                                        ¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥
¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒŸ
*/
VOID DATA::InvertProposition ( VOID ) {

	if ( ( KBase->GetCurAtt() < 0 ) || ( KBase->GetCurAtt() >= KBase->AttNumber() ) ) return;

	// àß¨•≠®‚Ï ™Æ≠ÍÓ≠™‚/§®ßÍÓ≠™‚ ® ¢·• ™Æ¨ØÆ≠•≠‚Î
	KBase->InvertProp();

	// á†ØÆ´≠®‚Ï ListBox'Î
	PrintOn();

	return;
	}

/*
⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒø
≥ ç†Á†‚Ï ‡•§†™‚®‡Æ¢†≠®• (Ô¢≠Î© ¢¢Æ§) ß≠†Á•≠®Ô ™Æ¨ØÆ≠•≠‚Î.        ≥ EditValue ≥
≥ à·ØÆ´Ïß„•‚·Ô Ø‡ÆÊ•§„‡† ComponentProc.                          ¿ƒƒƒƒƒƒƒƒƒƒƒ¥
¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒŸ
*/
VOID DATA::EditValue ( VOID ) {
	// ëÆß§†‚Ï Æ™≠Æ EDIT °•ß £‡†≠®Ê ≠† ¨•·‚• ™Æ¨ØÆ≠•≠‚Î
	// è•‡•§†‚Ï „Ø‡†¢´•≠®• Ì‚Æ¨„ Æ™≠„ ® ØÆß¢Æ´®‚Ï ¢¢•·‚® ß≠†Á•≠®• ™Æ¨ØÆ≠•≠‚Î
	// èÆ·´• ≠†¶†‚®Ô Enter ¢•‡≠„‚Ï ≠†ß†§, „≠®Á‚Æ¶®‚Ï Æ™≠Æ
	// èÆ´„Á•≠≠Æ• ß≠†Á•≠®• Ø‡®‡†¢≠Ô‚Ï ™Æ¨ØÆ≠•≠‚•
	// ??????????????????????????????????????????????????????????
	return;
	}

/*
⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø
≥ ì§†´®‚Ï ¢Î·™†ßÎ¢†≠®• Æ° †‚‡®°„‚• ®ß Ø‡†¢®´†.           ≥ DeleteProposition ≥
≥                                                        ¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥
¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒŸ
*/
VOID DATA::DeleteProposition ( VOID ) {

	if ( ( KBase->GetCurAtt() < 0 ) || ( KBase->GetCurAtt() >= KBase->AttNumber() ) )
		return;

/*	if ( IDYES != ErrorMessager  ( Frame.hwnd, MB_YESNO | MB_APPLMODAL | MB_ICONEXCLAMATION, IDS_DELETEPROPOSITION ) )
		return;
*/
	// ì§†´®‚Ï †‚‡®°„‚
	KBase->DelProp();

	// é‚‡†ß®‚Ï ‚•™„È•• ·Æ·‚ÆÔ≠®• ≠† Ì™‡†≠•
	PrintOn();

	return;
	}

/*
⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒø
≥ ì¨•≠ÏË®‚Ï ß≠†Á•≠®• ™Æ¨ØÆ≠•≠‚Î, ·ÆÆ‚¢•‚·‚¢„ÓÈ•© ß≠†Á•≠®Ó.     ≥ DeleteValue ≥
≥                                                              ¿ƒƒƒƒƒƒƒƒƒƒƒƒƒ¥
¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒŸ
*/
VOID DATA::DeleteValue ( VOID ) {

	if ( ( KBase->GetCurVal() < 0 ) || ( KBase->GetCurAtt() < 0 ) ||
         ( KBase->GetCurAtt() >= KBase->AttNumber() ) )
		return;

	if ( SplitState != IDM_VIEWNONE && CurFocus == hwndAtt ) return;

	COMP Comp;
	RECT rc;
	HWND hwnd;
	int Att = KBase->GetCurAtt();
	int Val = KBase->GetCurVal();

	if ( Val == -1 ) return;

	KBase->GetComp ( Att, Val, & Comp );
	if ( Comp.pos != 0 )      Comp.pos = 0;
	else                      return;
	KBase->SetComp ( Att, Val, & Comp );

	if ( SplitState == IDM_VIEWNONE )  hwnd = hwndAtt;
	else                               hwnd = hwndVal;
	SendMessage ( hwnd, LB_GETITEMRECT, SendMessage ( hwnd, LB_GETCURSEL, 0, 0L ), (DWORD) & rc );
	if ( SplitState != IDM_VIEWNONE )
		rc.left = 3 * BMPWIDTH + 3;
	else
		rc.left = 5 * BMPWIDTH + 3;
	rc.right = rc.left + COMPLENGTH;
	InvalidateRect ( hwnd, & rc, TRUE );

	return;
	}

/*
⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒø
≥ ì¢•´®Á®‚Ï ‚•™„È„Ó ™Æ¨ØÆ≠•≠‚„ ≠† 1. Ö·´® Æ≠† ‡†¢≠† UNITY, ‚Æ ≥ IncreaseComp ≥
≥ ≠• „¢•´®Á®¢†‚Ï.                                             ¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥
¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒŸ
*/
VOID DATA::IncreaseComp ( VOID ) {
	if ( SplitState != IDM_VIEWNONE && CurFocus == hwndAtt ) return;

	COMP Comp;
	RECT rc;
	HWND hwnd;
	int Att = KBase->GetCurAtt();
	int Val = KBase->GetCurVal();

	if ( Val == -1 ) return;

	KBase->GetComp ( Att, Val, & Comp );
	if ( Comp.pos != UNITY )  Comp.pos++;
	else                      return;
	KBase->SetComp ( Att, Val, & Comp );

	if ( SplitState == IDM_VIEWNONE )  hwnd = hwndAtt;
	else                               hwnd = hwndVal;
	SendMessage ( hwnd, LB_GETITEMRECT, SendMessage ( hwnd, LB_GETCURSEL, 0, 0L ), (DWORD) & rc );
	if ( SplitState != IDM_VIEWNONE )
		rc.left = 3 * BMPWIDTH;
	else
		rc.left = 5 * BMPWIDTH;
	rc.right = rc.left + COMPLENGTH;
	InvalidateRect ( hwnd, & rc, TRUE );
	}

/*
⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒø
≥ ì¨•≠ÏË®‚Ï ‚•™„È„Ó ™Æ¨ØÆ≠•≠‚„ ≠† 1. Ö·´® Æ≠† ‡†¢≠† 0, ‚Æ     ≥ DecreaseComp ≥
≥ ≠• „¨•≠ÏË†‚Ï.                                               ¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥
¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒŸ
*/
VOID DATA::DecreaseComp ( VOID ) {
	if ( SplitState != IDM_VIEWNONE && CurFocus == hwndAtt ) return;

	COMP Comp;
	RECT rc;
	HWND hwnd;
	int Att = KBase->GetCurAtt();
	int Val = KBase->GetCurVal();

	if ( Val == -1 ) return;

	KBase->GetComp ( Att, Val, & Comp );
	if ( Comp.pos != 0 )      Comp.pos--;
	else                      return;
	KBase->SetComp ( Att, Val, & Comp );

	if ( SplitState == IDM_VIEWNONE )  hwnd = hwndAtt;
	else                               hwnd = hwndVal;
	SendMessage ( hwnd, LB_GETITEMRECT, SendMessage ( hwnd, LB_GETCURSEL, 0, 0L ), (DWORD) & rc );
	if ( SplitState != IDM_VIEWNONE )
		rc.left = 3 * BMPWIDTH;
	else
		rc.left = 5 * BMPWIDTH;
	rc.right = rc.left + COMPLENGTH;
	InvalidateRect ( hwnd, & rc, TRUE );
	}

/*
⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø
≥ ÇÎØÆ´≠Ô•‚·Ô Ø‡® ®ß¨•≠•≠®® ™Æ¨ØÆ≠•≠‚Î. ç†ÂÆ§®‚ ØÆ´Æ¶•≠®•  ≥ ChangeComponent ≥
≥ ß†§†≠≠Æ© ™Æ¨ØÆ≠•≠‚Î ® ®≠¢†´®§®‡„•‚ •£Æ.                  ¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥
¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒŸ
*/
VOID DATA::ChangeComponent ( int Att, int Val ) {
/*
èÆ´Æ¶•≠®• ß†¢®·®‚ Æ‚ ¢®§†. Ç §¢„Æ™Æ≠≠Æ¨ ‡•¶®¨• •·´® ‚•™„È®© †‚‡®°„‚ ≠• ‡†¢•≠
ß†§†≠≠Æ¨„, ‚Æ ≠®Á•£Æ ≠• §•´†‚Ï, ‚.™., ™Æ¨ØÆ≠•≠‚Î Ø‡Æ·‚Æ ≠• ¢®§≠Æ ≠† Ì™‡†≠•.
à≠†Á• ≠•Æ°ÂÆ§®¨Æ ≠†©‚® ØÆß®Ê®Ó ß†§†≠≠Æ£Æ ß≠†Á•≠®Ô (Ø‡•Æ°‡†ßÆ¢†¢ Æ‚≠Æ·®‚•´Ï≠Î©
≠Æ¨•‡ ¢ †°·Æ´Ó‚≠Î©) ® •·´® Æ≠† ¢®§≠† ≠† Ì™‡†≠•, ‚Æ ®≠¢†´®§®‡Æ¢†‚Ï ••.

Ç ·´„Á†• Æ§≠ÆÆ™Æ≠≠Æ£Æ ‡•¶®¨† ≠•Æ°ÂÆ§®¨Æ ØÆ ß†§†≠≠Î¨ †‚‡®°„‚„ ® ß≠†Á•≠®Ó ≠†©‚®
ØÆß®Ê®Ó ™Æ¨ØÆ≠•≠‚Î ¢ ·Ø®·™• (· ØÆ¨ÆÈÏÓ ‰„≠™Ê®® MakeNoneIdx) ® ®≠¢†´®§®‡Æ¢†‚Ï ••.

ÇÆÆ°È•, ®≠¢†´®§®‡Æ¢†‚Ï ¨Æ¶≠Æ ≠• ¢•·Ï Ø‡Ô¨Æ„£Æ´Ï≠®™ ·‚‡Æ™®, † ‚Æ´Ï™Æ ‚„ Á†·‚Ï,
™Æ‚Æ‡†Ô ·Æ§•‡¶®‚ ™Æ¨ØÆ≠•≠‚„.
*/
	HWND hwnd;
	int  idx;
	RECT rc;

	if ( SplitState == IDM_VIEWNONE ) {
		hwnd = hwndAtt;
		idx = MakeNoneIdx ( Att, Val );
		}
	else {
		hwnd = hwndVal;
		idx = Val;
		}

	SendMessage ( hwnd, LB_GETITEMRECT, idx, (LPARAM) & rc );

	if ( SplitState == IDM_VIEWNONE )
		rc.left = 5 * BMPWIDTH;
	else
		rc.left = 3 * BMPWIDTH;

	rc.right = rc.left + COMPLENGTH;

	InvalidateRect ( hwnd, & rc, TRUE );
	}

/*
⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒø
≥                                                                 ≥ InitMenu ≥
≥                                                                 ¿ƒƒƒƒƒƒƒƒƒƒ¥
¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒŸ
*/
VOID DATA::InitMenu ( VOID ) {

	// é‚¨•‚®‚Ï ‚•™„È®© ¢®§ (≠† §†≠≠Î• ®´® ß†™´ÓÁ•≠®Ô)
	if ( KBase->GetView() == VIEW_DATA ) {
		CheckMenuItem ( GetSubMenu ( hMenu, 1 ), IDM_VIEWDATA, MF_CHECKED );
		CheckMenuItem ( GetSubMenu ( hMenu, 1 ), IDM_VIEWCONCLUSION, MF_UNCHECKED );
		}
	else if ( KBase->GetView() == VIEW_CONCLUSION ) {
		CheckMenuItem ( GetSubMenu ( hMenu, 1 ), IDM_VIEWDATA, MF_UNCHECKED );
		CheckMenuItem ( GetSubMenu ( hMenu, 1 ), IDM_VIEWCONCLUSION, MF_CHECKED );
		}

	// é‚¨•‚®‚Ï ·Æ·‚ÆÔ≠®• LISTBOX'Æ¢
	if ( SplitState == IDM_VIEWVERTICAL ) {
		CheckMenuItem ( GetSubMenu ( hMenu, 1 ), IDM_VIEWVERTICAL, MF_CHECKED );
		CheckMenuItem ( GetSubMenu ( hMenu, 1 ), IDM_VIEWHORIZONTAL, MF_UNCHECKED );
		}
	else if ( SplitState == IDM_VIEWHORIZONTAL ) {
		CheckMenuItem ( GetSubMenu ( hMenu, 1 ), IDM_VIEWVERTICAL, MF_UNCHECKED );
		CheckMenuItem ( GetSubMenu ( hMenu, 1 ), IDM_VIEWHORIZONTAL, MF_CHECKED );
		}
	else if ( SplitState == IDM_VIEWNONE ) {
		CheckMenuItem ( GetSubMenu ( hMenu, 1 ), IDM_VIEWVERTICAL, MF_UNCHECKED );
		CheckMenuItem ( GetSubMenu ( hMenu, 1 ), IDM_VIEWHORIZONTAL, MF_UNCHECKED );
		}

	if ( isAttSelected() ) {

		// á†Ø‡‚•®‚Ï Ø„≠™‚Î ¨•≠Ó ≠• Æ‚≠Æ·ÔÈ®•·Ô ™ Ì‚Æ¨„ Æ™≠„
		EnableMenuItem ( GetSubMenu ( hMenu, 1 ), IDM_ASINRULE, MF_ENABLED );
		EnableMenuItem ( GetSubMenu ( hMenu, 1 ), IDM_VALUES, MF_ENABLED );
		EnableMenuItem ( GetSubMenu ( hMenu, 1 ), IDM_CHARACTER, MF_GRAYED );

		// é‚¨•‚®‚Ï ‚•™„È„Ó ·Æ‡‚®‡Æ¢™„
		CheckMenuItem ( GetSubMenu ( hMenu, 1 ), IDM_ASINRULE,   MF_UNCHECKED );
		CheckMenuItem ( GetSubMenu ( hMenu, 1 ), IDM_UNSORTED,   MF_UNCHECKED );
		CheckMenuItem ( GetSubMenu ( hMenu, 1 ), IDM_NAME,       MF_UNCHECKED );
		CheckMenuItem ( GetSubMenu ( hMenu, 1 ), IDM_PRICE,      MF_UNCHECKED );
		CheckMenuItem ( GetSubMenu ( hMenu, 1 ), IDM_IMPORTANCE, MF_UNCHECKED );
		CheckMenuItem ( GetSubMenu ( hMenu, 1 ), IDM_VALUES,     MF_UNCHECKED );
		CheckMenuItem ( GetSubMenu ( hMenu, 1 ), IDM_CHARACTER,  MF_UNCHECKED );

		switch ( KBase->GetAttSort() ) {
			case - SORT_ASINRULE :
			case SORT_ASINRULE   : {
				CheckMenuItem ( GetSubMenu ( hMenu, 1 ), IDM_ASINRULE,   MF_CHECKED );
				break;
				}
			case - SORT_UNSORTED :
			case SORT_UNSORTED   : {
				CheckMenuItem ( GetSubMenu ( hMenu, 1 ), IDM_UNSORTED,   MF_CHECKED );
				break;
				}
			case - SORT_ALPHA    :
			case SORT_ALPHA      : {
				CheckMenuItem ( GetSubMenu ( hMenu, 1 ), IDM_NAME,       MF_CHECKED );
				break;
				}
			case - SORT_VALNUM   :
			case SORT_VALNUM     : {
				CheckMenuItem ( GetSubMenu ( hMenu, 1 ), IDM_VALUES,     MF_CHECKED );
				break;
				}
			case - SORT_PRICE    :
			case SORT_PRICE      : {
				CheckMenuItem ( GetSubMenu ( hMenu, 1 ), IDM_PRICE,      MF_CHECKED );
				break;
				}
			case - SORT_IMPORTANCE :
			case SORT_IMPORTANCE   : {
				CheckMenuItem ( GetSubMenu ( hMenu, 1 ), IDM_IMPORTANCE, MF_CHECKED );
				break;
				}
/*			case - SORT_CHARACTER:
			case SORT_CHARACTER  : {
				CheckMenuItem ( GetSubMenu ( hMenu, 1 ), IDM_CHARACTER,  MF_CHECKED );
				break;
				}
*/			}

	   	 // é‚¨•‚®‚Ï Ø‡®·„‚·‚¢®• Æ°‡†‚≠Æ© ·Æ‡‚®‡Æ¢™®
		if ( KBase->GetAttSort() < 0 )
			CheckMenuItem ( GetSubMenu ( hMenu, 1 ), IDM_REVERSE, MF_CHECKED );
		else
			CheckMenuItem ( GetSubMenu ( hMenu, 1 ), IDM_REVERSE, MF_UNCHECKED );

		}
	else {                                                // Ñ´Ô Æ™≠† ß≠†Á•≠®©

		// á†Ø‡‚•®‚Ï Ø„≠™‚Î ¨•≠Ó ≠• Æ‚≠Æ·ÔÈ®•·Ô ™ Ì‚Æ¨„ Æ™≠„
		EnableMenuItem ( GetSubMenu ( hMenu, 1 ), IDM_ASINRULE, MF_GRAYED );
		EnableMenuItem ( GetSubMenu ( hMenu, 1 ), IDM_VALUES, MF_GRAYED );
		EnableMenuItem ( GetSubMenu ( hMenu, 1 ), IDM_CHARACTER, MF_ENABLED );

		// é‚¨•‚®‚Ï ‚•™„È„Ó ·Æ‡‚®‡Æ¢™„
		CheckMenuItem ( GetSubMenu ( hMenu, 1 ), IDM_ASINRULE,   MF_UNCHECKED );
		CheckMenuItem ( GetSubMenu ( hMenu, 1 ), IDM_UNSORTED,   MF_UNCHECKED );
		CheckMenuItem ( GetSubMenu ( hMenu, 1 ), IDM_NAME,       MF_UNCHECKED );
		CheckMenuItem ( GetSubMenu ( hMenu, 1 ), IDM_PRICE,      MF_UNCHECKED );
		CheckMenuItem ( GetSubMenu ( hMenu, 1 ), IDM_IMPORTANCE, MF_UNCHECKED );
		CheckMenuItem ( GetSubMenu ( hMenu, 1 ), IDM_VALUES,     MF_UNCHECKED );
		CheckMenuItem ( GetSubMenu ( hMenu, 1 ), IDM_CHARACTER,  MF_UNCHECKED );

		switch ( KBase->GetValSort() ) {
/*			case - IDM_ASINRULE :
			case IDM_ASINRULE   : {
				CheckMenuItem ( GetSubMenu ( hMenu, 1 ), IDM_UNSORTED,   MF_CHECKED );
				break;
				}
*/			case - SORT_UNSORTED :
			case SORT_UNSORTED   : {
				CheckMenuItem ( GetSubMenu ( hMenu, 1 ), IDM_UNSORTED,   MF_CHECKED );
				break;
				}
			case - SORT_ALPHA    :
			case SORT_ALPHA      : {
				CheckMenuItem ( GetSubMenu ( hMenu, 1 ), IDM_NAME,       MF_CHECKED );
				break;
				}
			case - SORT_VALNUM   :
			case SORT_VALNUM     : {
				CheckMenuItem ( GetSubMenu ( hMenu, 1 ), IDM_VALUES,     MF_CHECKED );
				break;
				}
			case - SORT_PRICE    :
			case SORT_PRICE      : {
				CheckMenuItem ( GetSubMenu ( hMenu, 1 ), IDM_PRICE,      MF_CHECKED );
				break;
				}
			case - SORT_IMPORTANCE :
			case SORT_IMPORTANCE   : {
				CheckMenuItem ( GetSubMenu ( hMenu, 1 ), IDM_IMPORTANCE, MF_CHECKED );
				break;
				}
			case - SORT_CHARACTER :
			case SORT_CHARACTER   : {
				CheckMenuItem ( GetSubMenu ( hMenu, 1 ), IDM_CHARACTER,  MF_CHECKED );
				break;
				}
			}

	   	 // é‚¨•‚®‚Ï Ø‡®·„‚·‚¢®• Æ°‡†‚≠Æ© ·Æ‡‚®‡Æ¢™®
		if ( KBase->GetValSort() < 0 )
			CheckMenuItem ( GetSubMenu ( hMenu, 1 ), IDM_REVERSE, MF_CHECKED );
		else
			CheckMenuItem ( GetSubMenu ( hMenu, 1 ), IDM_REVERSE, MF_UNCHECKED );

		}

	}

/*
⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒø
≥                                                              ≥ DrawItemBmp ≥
≥                                                              ¿ƒƒƒƒƒƒƒƒƒƒƒƒƒ¥
¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒŸ
*/
VOID DATA::DrawItemBmp ( LPDRAWITEMSTRUCT lpDIS, int WhatToDraw, BOOL Last ) {

	HPEN SavePen = SelectObject ( lpDIS->hDC, CreatePen ( PS_SOLID, 1, RGB(0,0,255) ) );
	HDC hdcCompat = CreateCompatibleDC ( lpDIS->hDC );

	// èÆ§£Æ‚†¢´®¢†•¨ °®‚¨†ØÎ §´Ô ‡®·Æ¢†≠®Ô
	// Ñ´Ô ØÆ·´•§≠•£Æ (¢·ØÆ¨Æ£†‚•´Ï≠Æ£Æ) °®‚¨†Ø ≠• ß†£‡„¶†•‚·Ô ‚.™. ≠• ®·ØÆ´Ïß„•‚·Ô
	// Ç Ø‡®≠Ê®Ø•, ¨Æ¶≠Æ °Î´Æ °Î ® ß†£‡„ß®‚Ï (°•ß ®·ØÆ´ÏßÆ¢†≠®Ô), ≠Æ ‰„≠™Ê®Ô
	// isPropConjunct §´Ô ¢·ØÆ¨Æ£†‚•´Ï≠Æ£Æ †‚‡®°„‚† §†•‚ ÆË®°™„.
	// (Ö·´® †‚‡®°„‚ ØÆ·´•§≠®©, ‚Æ ß†£‡„¶†•‚·Ô °®‚¨†Ø ß≠†Á•≠®© ® ≠• ®·ØÆ´Ïß„•‚·Ô.)
	if ( WhatToDraw == IDM_ATT_LISTBOX && ! Last )

		if ( SplitState == IDM_VIEWNONE  )
			if ( KBase->isPropConjunct ( NoneIdx2Att ( lpDIS->itemID ) ) )
				SelectObject ( hdcCompat, hbmpAttIn );       // ™Æ≠ÍÓ≠™‚®¢≠Æ• ¢Î·™†ßÎ¢†≠®•
			else
				SelectObject ( hdcCompat, hbmpAttOut );      // §®ßÍÓ≠™‚®¢≠Æ• ¢Î·™†ßÎ¢†≠®•
		else
			if ( KBase->isPropConjunct ( KBase->Prop2Att ( lpDIS->itemID ) ) )
				SelectObject ( hdcCompat, hbmpAttIn );
			else
				SelectObject ( hdcCompat, hbmpAttOut );

	else
		SelectObject ( hdcCompat, hbmpVal );

	if ( SplitState != IDM_VIEWNONE )                      // Ñ¢„Æ™Æ≠≠Î© ‡•¶®¨

		if ( Last ) {                                            // ê®·„•¨ ¿ƒ
			MoveTo ( lpDIS->hDC, lpDIS->rcItem.left + BMPWIDTH, lpDIS->rcItem.top);
			LineTo ( lpDIS->hDC, lpDIS->rcItem.left + BMPWIDTH, lpDIS->rcItem.top + (int) Frame.LBitemHight/2 );
			LineTo ( lpDIS->hDC, lpDIS->rcItem.left + 2 * BMPWIDTH, lpDIS->rcItem.top + (int) Frame.LBitemHight/2 );

			if ( WhatToDraw == IDM_VAL_LISTBOX )             // ÑÆ°†¢´Ô•¨ ¿ƒ˛
				BitBlt ( lpDIS->hDC, lpDIS->rcItem.left + 2 * BMPWIDTH, lpDIS->rcItem.top + (int) Frame.LBitemHight/2 - 5 , 10, 10, hdcCompat, 0, 0, SRCCOPY );
        	}
		else if ( lpDIS->itemID == 0 ) {                        // ê®·„•¨ ⁄ƒ˛
			MoveTo ( lpDIS->hDC, lpDIS->rcItem.left + BMPWIDTH, lpDIS->rcItem.bottom );
			LineTo ( lpDIS->hDC, lpDIS->rcItem.left + BMPWIDTH, lpDIS->rcItem.top + (int) Frame.LBitemHight/2 );
			LineTo ( lpDIS->hDC, lpDIS->rcItem.left + 2 * BMPWIDTH, lpDIS->rcItem.top + (int) Frame.LBitemHight/2 );
			BitBlt ( lpDIS->hDC, lpDIS->rcItem.left + 2 * BMPWIDTH, lpDIS->rcItem.top + (int) Frame.LBitemHight/2 - 5 , 10, 10, hdcCompat, 0, 0, SRCCOPY );
			}
        else {                                                  // ê®·„•¨ √ƒ˛
			MoveTo ( lpDIS->hDC, lpDIS->rcItem.left + BMPWIDTH, lpDIS->rcItem.top);
			LineTo ( lpDIS->hDC, lpDIS->rcItem.left + BMPWIDTH, lpDIS->rcItem.top + Frame.LBitemHight );
			MoveTo ( lpDIS->hDC, lpDIS->rcItem.left + BMPWIDTH, lpDIS->rcItem.top + (int) Frame.LBitemHight/2);
			LineTo ( lpDIS->hDC, lpDIS->rcItem.left + 2 * BMPWIDTH, lpDIS->rcItem.top + (int) Frame.LBitemHight/2 );
			BitBlt ( lpDIS->hDC, lpDIS->rcItem.left + 2 * BMPWIDTH, lpDIS->rcItem.top + (int) Frame.LBitemHight/2 - 5, 10, 10, hdcCompat, 0, 0, SRCCOPY );
        	}

	else                                                  // é§≠ÆÆ™Æ≠≠Î© ‡•¶®¨
		if ( WhatToDraw == IDM_ATT_LISTBOX )                 // ê®·„•¨ †‚‡®°„‚
			if ( Last ) {                                     // ê®·„•¨ ¿ƒƒƒ˛
				MoveTo ( lpDIS->hDC, lpDIS->rcItem.left + BMPWIDTH, lpDIS->rcItem.top);
				LineTo ( lpDIS->hDC, lpDIS->rcItem.left + BMPWIDTH, lpDIS->rcItem.top + (int) Frame.LBitemHight/2 );
				LineTo ( lpDIS->hDC, lpDIS->rcItem.left + 3 * BMPWIDTH, lpDIS->rcItem.top + (int) Frame.LBitemHight/2 );
				// ä†‡‚®≠™† §´Ô ØÆ·´•§≠•£Æ (¢·ØÆ¨Æ£†•‚´Ï≠Æ£Æ) †‚‡®°„‚† (ØÆ™† ≠•‚)
				// BitBlt ( lpDIS->hDC, lpDIS->rcItem.left + 3 * BMPWIDTH, lpDIS->rcItem.top + (int) Frame.LBitemHight/2 - 5 , 10, 10, hdcCompat, 0, 0, SRCCOPY );
   		 		}
			else {                                            // ê®·„•¨ √ƒ¬ƒ˛
				MoveTo ( lpDIS->hDC, lpDIS->rcItem.left + BMPWIDTH, lpDIS->rcItem.top);
				LineTo ( lpDIS->hDC, lpDIS->rcItem.left + BMPWIDTH, lpDIS->rcItem.top + Frame.LBitemHight );
				MoveTo ( lpDIS->hDC, lpDIS->rcItem.left + BMPWIDTH, lpDIS->rcItem.top + (int) Frame.LBitemHight/2);
				LineTo ( lpDIS->hDC, lpDIS->rcItem.left + 3 * BMPWIDTH, lpDIS->rcItem.top + (int) Frame.LBitemHight/2 );
				MoveTo ( lpDIS->hDC, lpDIS->rcItem.left + 2 * BMPWIDTH, lpDIS->rcItem.top + (int) Frame.LBitemHight/2);
				LineTo ( lpDIS->hDC, lpDIS->rcItem.left + 2 * BMPWIDTH, lpDIS->rcItem.top + Frame.LBitemHight );
				BitBlt ( lpDIS->hDC, lpDIS->rcItem.left + 3 * BMPWIDTH, lpDIS->rcItem.top + (int) Frame.LBitemHight/2 - 5, 10, 10, hdcCompat, 0, 0, SRCCOPY );
       		 	}
		else                                                // ê®·„•¨ ß≠†Á•≠®•
			if ( Last ) {                                     // ê®·„•¨ ≥ ¿ƒ˛
				MoveTo ( lpDIS->hDC, lpDIS->rcItem.left + BMPWIDTH, lpDIS->rcItem.top);
				LineTo ( lpDIS->hDC, lpDIS->rcItem.left + BMPWIDTH, lpDIS->rcItem.top + Frame.LBitemHight );
				MoveTo ( lpDIS->hDC, lpDIS->rcItem.left + 2 * BMPWIDTH, lpDIS->rcItem.top );
				LineTo ( lpDIS->hDC, lpDIS->rcItem.left + 2 * BMPWIDTH, lpDIS->rcItem.top + (int) Frame.LBitemHight/2 );
				LineTo ( lpDIS->hDC, lpDIS->rcItem.left + 4 * BMPWIDTH, lpDIS->rcItem.top + (int) Frame.LBitemHight/2 );
				BitBlt ( lpDIS->hDC, lpDIS->rcItem.left + 4 * BMPWIDTH, lpDIS->rcItem.top + (int) Frame.LBitemHight/2 - 5 , 10, 10, hdcCompat, 0, 0, SRCCOPY );
   		 		}
			else {                                            // ê®·„•¨ ≥ √ƒ˛
				MoveTo ( lpDIS->hDC, lpDIS->rcItem.left + BMPWIDTH, lpDIS->rcItem.top);
				LineTo ( lpDIS->hDC, lpDIS->rcItem.left + BMPWIDTH, lpDIS->rcItem.top + Frame.LBitemHight );
				MoveTo ( lpDIS->hDC, lpDIS->rcItem.left + 2 * BMPWIDTH, lpDIS->rcItem.top );
				LineTo ( lpDIS->hDC, lpDIS->rcItem.left + 2 * BMPWIDTH, lpDIS->rcItem.top + Frame.LBitemHight );
				MoveTo ( lpDIS->hDC, lpDIS->rcItem.left + 2 * BMPWIDTH, lpDIS->rcItem.top + (int) Frame.LBitemHight/2);
				LineTo ( lpDIS->hDC, lpDIS->rcItem.left + 4 * BMPWIDTH, lpDIS->rcItem.top + (int) Frame.LBitemHight/2 );
				BitBlt ( lpDIS->hDC, lpDIS->rcItem.left + 4 * BMPWIDTH, lpDIS->rcItem.top + (int) Frame.LBitemHight/2 - 5, 10, 10, hdcCompat, 0, 0, SRCCOPY );
       		 	}

	DeleteObject ( SelectObject ( lpDIS->hDC, SavePen ) );
	DeleteDC ( hdcCompat );

	}

/*
⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒø
≥                                                             ≥ DrawItemText ≥
≥                                                             ¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥
¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒŸ
*/
VOID DATA::DrawItemText ( LPDRAWITEMSTRUCT lpDIS, int WhatToDraw, int Pos ) {
	char buf[128];
	HBRUSH hCompBrush, hTextBrush;
	RECT rcComp = lpDIS->rcItem;  rcComp.left += Pos; rcComp.right = rcComp.left + COMPLENGTH;
	RECT rcText = lpDIS->rcItem;  rcText.left += Pos + COMPLENGTH;
	COLORREF hTextClr, hTextBkg, hCompBkg, hCompClr = RGB(255,0,0);

	hCompBrush = CreateSolidBrush ( GetSysColor ( COLOR_WINDOW ) );
	hCompBkg = GetSysColor ( COLOR_WINDOW );

	if ( lpDIS->itemState & ODS_SELECTED ) {
		hTextBrush = CreateSolidBrush ( GetSysColor ( COLOR_HIGHLIGHT ) );
		hTextClr = GetSysColor ( COLOR_HIGHLIGHTTEXT );
		hTextBkg = GetSysColor ( COLOR_HIGHLIGHT );
		}
	else {
		hTextBrush = hCompBrush;
		hTextClr = GetSysColor ( COLOR_WINDOWTEXT );
		hTextBkg = hCompBkg;
		}

	// Ç·• ØÆ§£Æ‚Æ¢®´®, ≠†Á®≠†•¨ ‡®·Æ¢†‚Ï
	if ( WhatToDraw == IDM_VAL_LISTBOX ) {

		// èÆ´„Á®‚Ï ß≠†Á•≠®• ™Æ¨ØÆ≠•≠‚Î ® Ø‡•Æ°‡†ßÆ¢†‚Ï •£Æ ¢ ‚•™·‚
		COMP Comp;
		int Att, Val;
		if ( SplitState != IDM_VIEWNONE ) {
			Att = KBase->GetCurAtt();
			Val = lpDIS->itemID;
			}
		else {
			Att = NoneIdx2Att ( lpDIS->itemID );
			Val = NoneIdx2Val ( lpDIS->itemID );
			}
		// Ç·ØÆ¨Æ£†‚•´Ï≠†Ô ™Æ¨ØÆ≠•≠‚† ≠• ØÆ™†ßÎ¢†•‚·Ô, ØÆÌ‚Æ¨„ ÆË®°™® ≠• °„§•‚
		KBase->GetComp ( Att, Val, & Comp );            // èÆ´„Á®‚Ï ™Æ¨ØÆ≠•≠‚„
		itoa ( (int) Comp.pos, buf, 10 );

		// èÆ§£Æ‚Æ¢®‚Ï Æ°´†·‚Ï §´Ô ‡®·Æ¢†≠®Ô, ‚.•., ß†™‡†·®‚Ï •• ≠„¶≠Î¨ Ê¢•‚Æ¨ ¢ ß†¢®·®¨Æ·‚® Æ‚ ¢Î§•´•≠®Ô
		FillRect ( lpDIS->hDC, & rcComp, hCompBrush );
		FillRect ( lpDIS->hDC, & rcText, hTextBrush );

		// ì·‚†≠Æ¢®‚Ï Ê¢•‚† §´Ô ‡®·Æ¢†≠®Ô ™Æ¨ØÆ≠•≠‚Î
		SetTextColor ( lpDIS->hDC, hCompClr );
		SetBkColor ( lpDIS->hDC, hCompBkg );

		TextOut ( lpDIS->hDC, rcComp.left + 3, rcComp.top, buf, lstrlen ( buf ) );

		// ì·‚†≠Æ¢®‚Ï Ê¢•‚† §´Ô ‡®·Æ¢†≠®Ô ‚•™·‚†
		SetTextColor ( lpDIS->hDC, hTextClr );
		SetBkColor ( lpDIS->hDC, hTextBkg );

		TextOut ( lpDIS->hDC, rcText.left + 3, rcText.top, buf,
			(int) SendMessage ( lpDIS->hwndItem, LB_GETTEXT, lpDIS->itemID, (LPARAM) buf )
			);
		}
	else {
		// èÆ§£Æ‚Æ¢®‚Ï Æ°´†·‚Ï §´Ô ‡®·Æ¢†≠®Ô, ‚.•., ß†™‡†·®‚Ï •• ≠„¶≠Î¨ Ê¢•‚Æ¨ ¢ ß†¢®·®¨Æ·‚® Æ‚ ¢Î§•´•≠®Ô
		rcText = lpDIS->rcItem;
		rcText.left += Pos;
		FillRect ( lpDIS->hDC, & rcText, hTextBrush );

		// ì·‚†≠Æ¢®‚Ï Ê¢•‚† §´Ô ‡®·Æ¢†≠®Ô ‚•™·‚†
		SetTextColor ( lpDIS->hDC, hTextClr );
		SetBkColor ( lpDIS->hDC, hTextBkg );

		TextOut ( lpDIS->hDC, rcText.left + 3, rcText.top, buf,
			(int) SendMessage ( lpDIS->hwndItem, LB_GETTEXT, lpDIS->itemID, (DWORD) buf ) );

		}

	DeleteObject ( hCompBrush );
	if ( lpDIS->itemState & ODS_SELECTED )
		DeleteObject ( hTextBrush );

	}

/*
⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒø
≥                                                                 ≥ DrawItem ≥
≥                                                                 ¿ƒƒƒƒƒƒƒƒƒƒ¥
¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒŸ
*/
VOID DATA::DrawItem ( LPDRAWITEMSTRUCT lpDIS ) {

	if ( SplitState != IDM_VIEWNONE ) {
		RECT rc = lpDIS->rcItem;

		if ( lpDIS->CtlID == IDM_ATT_LISTBOX )  rc.left += 3 * BMPWIDTH;
		else                                    rc.left += 3 * BMPWIDTH + COMPLENGTH;

		switch ( lpDIS->itemAction ) {

		case ODA_SELECT :
			// ÇÎØÆ´≠Ô•¨ ØÆ´≠„Ó Ø‡Æ£‡†¨¨„. ù‚Æ ≠•¨≠Æ£Æ ≠•Ì‰‰•™‚®¢≠Æ (°®‚¨ÌØÎ
			// ‡®·Æ¢†‚Ï ¢ §•©·‚¢®‚•´Ï≠Æ·‚® ≠• ≠†§Æ, † ‚Æ´Ï™Æ ‚•™·‚), ≠Æ ß†‚Æ Ø‡Æ·‚Æ.

			// è‡®·‚•£≠®‚• ‡•¨≠® ® §ÎË®‚• £´„°¶•; Ø‡Æ¢†´®¢†•¨·Ô ¢ ·´•§„ÓÈ®© ™•©·...

		case ODA_DRAWENTIRE : {                  // ç†‡®·Æ¢†‚Ï ØÆ´≠Æ·‚ÏÓ Ø„≠™‚

			if ( lpDIS->CtlID == IDM_ATT_LISTBOX ) {// ê®·„•¨ ¢ Æ™≠• †‚‡®°„‚Æ¢

				if ( lpDIS->itemID == KBase->PropNumber() )  // è„·‚Æ© †‚‡®°„‚
					DrawItemBmp ( lpDIS, lpDIS->CtlID, TRUE );
				else                                     // çÆ‡¨†´Ï≠Î© †‚‡®°„‚
					DrawItemBmp ( lpDIS, lpDIS->CtlID, FALSE );

				DrawItemText ( lpDIS, IDM_ATT_LISTBOX, 3 * BMPWIDTH );
				}
	        else {                                   // ê®·„•¨ ¢ Æ™≠• ß≠†Á•≠®©

				if ( lpDIS->itemID == KBase->ValNumber ( KBase->GetCurAtt() ) - 1 )
					DrawItemBmp ( lpDIS, lpDIS->CtlID, TRUE );   // èÆ·´•§≠•• ß≠†Á•≠®•
				else
					DrawItemBmp ( lpDIS,  lpDIS->CtlID, FALSE );// çÆ‡¨†´Ï≠Æ• ß≠†Á•≠®•

				DrawItemText ( lpDIS, IDM_VAL_LISTBOX, 3 * BMPWIDTH );
				}
			break;
			}                                           // case ODA_DRAWENTIRE

		case ODA_FOCUS : {
			// èÆ·‚†¢®‚Ï ‰Æ™„·
			DrawFocusRect ( lpDIS->hDC, & rc );
			break;
			}
		}                                      // switch ( lpDIS->itemAction )

        }                                 // if ( SplitState != IDM_VIEWNONE )

	else {                                              // ê®·„•¨ Ø‡® NONEVIEW
		RECT rc = lpDIS->rcItem;

		if ( NoneIdx2Val ( lpDIS->itemID ) == -1 )  rc.left += 4 * BMPWIDTH;
		else                                        rc.left += 5 * BMPWIDTH + COMPLENGTH;

		switch ( lpDIS->itemAction ) {

		case ODA_SELECT :
			// ÇÎØÆ´≠Ô•¨ ØÆ´≠„Ó Ø‡Æ£‡†¨¨„. ù‚Æ ≠•¨≠Æ£Æ ≠•Ì‰‰•™‚®¢≠Æ (°®‚¨ÌØÎ
			// ‡®·Æ¢†‚Ï ¢ §•©·‚¢®‚•´Ï≠Æ·‚® ≠• ≠†§Æ, † ‚Æ´Ï™Æ ‚•™·‚), ≠Æ ß†‚Æ Ø‡Æ·‚Æ.

			// è‡®·‚•£≠®‚• ‡•¨≠® ® §ÎË®‚• £´„°¶•; Ø‡Æ¢†´®¢†•¨·Ô ¢ ·´•§„ÓÈ®© ™•©·...

		case ODA_DRAWENTIRE : {                  // ç†‡®·Æ¢†‚Ï ØÆ´≠Æ·‚ÏÓ Ø„≠™‚

			if ( NoneIdx2Val ( lpDIS->itemID ) == -1 ) {     // ê®·„•¨ †‚‡®°„‚

				if ( NoneIdx2Att ( lpDIS->itemID ) == KBase->AttNumber() ) // è„·‚Æ© †‚‡®°„‚
					DrawItemBmp ( lpDIS, IDM_ATT_LISTBOX, TRUE );
				else                                     // çÆ‡¨†´Ï≠Î© †‚‡®°„‚
					DrawItemBmp ( lpDIS, IDM_ATT_LISTBOX, FALSE );

				DrawItemText ( lpDIS, IDM_ATT_LISTBOX, 4 * BMPWIDTH );
				}

			else {                                          // ê®·„•¨ ß≠†Á•≠®•
				if ( NoneIdx2Val ( lpDIS->itemID ) == KBase->ValNumber ( NoneIdx2Att ( lpDIS->itemID ) ) - 1 )
					DrawItemBmp ( lpDIS, IDM_VAL_LISTBOX, TRUE );// èÆ·´•§≠•• ß≠†Á•≠®•
				else
					DrawItemBmp ( lpDIS, IDM_VAL_LISTBOX, FALSE ); // çÆ‡¨†´Ï≠Æ• ß≠†Á•≠®•

				DrawItemText ( lpDIS, IDM_VAL_LISTBOX, 5 * BMPWIDTH );
				}
			break;
			}                                           // case ODA_DRAWENTIRE

		case ODA_FOCUS : {
			// èÆ·‚†¢®‚Ï ‰Æ™„·
			DrawFocusRect ( lpDIS->hDC, & rc );
			break;
			}
		}                                      // switch ( lpDIS->itemAction )
		}

	}

/*
⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒø
≥                                                                ≥ ChangeWin ≥
≥                                                                ¿ƒƒƒƒƒƒƒƒƒƒƒ¥
¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒŸ
*/
VOID DATA::ChangeWin ( VOID ) {
	if ( SplitState != IDM_VIEWNONE ) {
        if ( CurFocus == IDM_ATT_LISTBOX ) CurFocus = IDM_VAL_LISTBOX;
        else CurFocus = IDM_ATT_LISTBOX;
    	SetFocus ( );
    	}
	}

/*
⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø
≥                                                            ≥ isAttSelected ≥
≥                                                            ¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥
¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒŸ
*/
BOOL DATA::isAttSelected ( VOID ) {
	if ( ( ( SplitState != IDM_VIEWNONE ) && ( CurFocus == IDM_ATT_LISTBOX ) ) ||
           ( SplitState == IDM_VIEWNONE ) && ( KBase->GetCurVal() == -1 ) )
		return TRUE;
	else
		return FALSE;
	}

/*
⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø
≥                                                            ≥ isValSelected ≥
≥                                                            ¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥
¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒŸ
*/
BOOL DATA::isValSelected ( VOID ) {
	if ( ( ( SplitState != IDM_VIEWNONE ) && ( CurFocus == IDM_VAL_LISTBOX ) ) ||
           ( SplitState == IDM_VIEWNONE ) && ( KBase->GetCurVal() != -1 ) )
		return TRUE;
	else
		return FALSE;
	}

/*
⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø
≥ á†ØÆ´≠Ô•‚ ListBox ¢ §®†´Æ£• hwnd ®¨•≠†¨® †‚‡®°„‚Æ¢,     ≥ FillPropositions ≥
≥ ™Æ‚Æ‡Î• ≠• ¢·‚‡•Á†Ó‚·Ô ¢ §†≠≠ÎÂ.                        ¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥
¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒŸ
*/
VOID DATA::FillPropositions ( HWND hwnd ) {

	int i, s, w = 0, maxWidth = 0;
	if ( SendDlgItemMessage ( hwnd, IDD_UNSORTED,   BM_GETCHECK, 0, 0L ) ) s = SORT_UNSORTED;
	if ( SendDlgItemMessage ( hwnd, IDD_NAME,       BM_GETCHECK, 0, 0L ) ) s = SORT_ALPHA;
	if ( SendDlgItemMessage ( hwnd, IDD_VALNUM,     BM_GETCHECK, 0, 0L ) ) s = SORT_VALNUM;
	if ( SendDlgItemMessage ( hwnd, IDD_PRICE,      BM_GETCHECK, 0, 0L ) ) s = SORT_PRICE;
	if ( SendDlgItemMessage ( hwnd, IDD_IMPORTANCE, BM_GETCHECK, 0, 0L ) ) s = SORT_IMPORTANCE;

	if ( SendDlgItemMessage ( hwnd, IDD_REVERSE, BM_GETCHECK, 0, 0L ) )
		KBase->SetAttSort ( - s );
	else
		KBase->SetAttSort ( s );

	// á†ØÆ´≠®‚Ï ListBox ®¨•≠†¨® †‚‡®°„‚Æ¢
	SendDlgItemMessage ( hwnd, IDD_PROP, WM_SETREDRAW, FALSE, 0L );
	SendDlgItemMessage ( hwnd, IDD_PROP, LB_RESETCONTENT, 0, 0L );
	HDC hDC = GetDC ( GetDlgItem ( hwnd, IDD_PROP ) );

	for ( i = 0; i < KBase->AttNumber(); i++ ) {

		if ( ! KBase->isAttEnabled ( i ) ) {
			ATT_REC  AttRec;
			KBase->GetAttribute ( i, & AttRec );

			// ÇÎÁ®·´®‚Ï Ë®‡®≠„ •£Æ ≠†ß¢†≠®Ô ® ·‡†¢≠®‚Ï · ‚•™„È•© (•·´® °Æ´ÏË•, ‚Æ ·§•´†‚Ï ‚•™„È•©)
			w = LOWORD ( GetTextExtent ( hDC, (LPSTR) & AttRec.Name, lstrlen ( (LPSTR) & AttRec.Name) ) );
			if ( maxWidth < w ) maxWidth = w;

			// á†≠•·‚® †‚‡®°„‚ ¢ ListBox
			SendDlgItemMessage ( hwnd, IDD_PROP, LB_ADDSTRING, 0, (DWORD) & AttRec.Name );
			}
		}
	ReleaseDC ( GetDlgItem ( hwnd, IDD_PROP ), hDC );
	SendDlgItemMessage ( hwnd, IDD_PROP, LB_SETHORIZONTALEXTENT, maxWidth+5, 0 );

	SendDlgItemMessage ( hwnd, IDD_PROP, LB_SETCURSEL, 0, 0 );
	SendDlgItemMessage ( hwnd, IDD_PROP, WM_SETREDRAW, TRUE, 0L );
	InvalidateRect ( GetDlgItem ( hwnd, IDD_PROP ), NULL, FALSE );
	}

/*
⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒø
≥ î„≠™Ê®Ô ¢Î°Æ‡† †‚‡®°„‚† ®ß ·Ø®·™† §´Ô ¢·‚†¢™® ¢Î·™†ßÎ¢†-  ≥ DataProposProc ≥
≥ ≠®Ô ¢ §†≠≠Î•. èÆ´„Á†•‚ „™†ß†‚•´Ï ≠† Æ°Í•™‚ Æ™≠† Ø‡†¢®´    ¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¥
≥ ® ¢Æß¢‡†È†•‚ ≠Æ¨•‡ ¢Î°‡†≠≠Æ£Æ ØÆ´ÏßÆ¢†‚•´•¨ †‚‡®°„‚†. Ç ·Ø®·™• †‚‡®°„‚Æ¢   ≥
≥ „™†ßÎ¢†Ó‚·Ô ‚Æ´Ï™Æ ‚•, ™Æ‚Æ‡ÎÂ •È• ≠•‚ ¢ §†≠≠ÎÂ.                           ≥
¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒŸ
*/
BOOL FAR PASCAL _export DataProposProc ( HWND hwnd, UINT msg, WPARAM wParam, LPARAM lParam ) {
	static LPDATA pData;
	static int PrevSort;

    switch ( msg ) {
		case WM_INITDIALOG : {

			pData = (LPDATA) lParam;
			PrevSort = pData->KBase->GetAttSort();

			// èÆ™†ß†‚Ï ‚•™„È„Ó ·Æ‡‚®‡Æ¢™„ ® ØÆ´Æ¶®‚•´Ï≠Æ·‚Ï
			if ( PrevSort < 0 )
				SendDlgItemMessage ( hwnd, IDD_REVERSE, BM_SETCHECK, 1, 0L );
			else
				SendDlgItemMessage ( hwnd, IDD_REVERSE, BM_SETCHECK, 0, 0L );

			SendDlgItemMessage ( hwnd, IDD_CONCLUSION, BM_SETCHECK, 1, 0L );

			EnableWindow ( GetDlgItem ( hwnd, IDD_PREMCONCGROUP ), FALSE );
			EnableWindow ( GetDlgItem ( hwnd, IDD_PREMISE ), FALSE );
			EnableWindow ( GetDlgItem ( hwnd, IDD_CONCLUSION ), FALSE );

			int i;
			switch ( PrevSort ) {
				case - SORT_ASINRULE   :
				case SORT_ASINRULE     : i = IDD_UNSORTED;   break;
				case - SORT_UNSORTED   :
				case SORT_UNSORTED     : i = IDD_UNSORTED;   break;
				case - SORT_ALPHA      :
				case SORT_ALPHA        : i = IDD_NAME;       break;
				case - SORT_VALNUM     :
				case SORT_VALNUM       : i = IDD_VALNUM;     break;
				case - SORT_PRICE      :
				case SORT_PRICE        : i = IDD_PRICE;      break;
				case - SORT_IMPORTANCE :
				case SORT_IMPORTANCE   : i = IDD_IMPORTANCE; break;
				}
			SendDlgItemMessage ( hwnd, i, BM_SETCHECK, 1, 0L );

			pData->FillPropositions ( hwnd );
			::SetFocus ( GetDlgItem ( hwnd, IDD_PROP ) );
			break;
			}
		case WM_COMMAND : {
			switch ( wParam ) {
				case IDOK : {
					char Name[ATT_NAME_LEN];

					if ( -1 == SendDlgItemMessage ( hwnd, IDD_PROP, LB_GETCURSEL, 0, 0L ) ) {
						EndDialog ( hwnd, -1 );
						break;
						}

					// ÇßÔ‚Ï ·‚‡Æ™„ ®¨•≠® †‚‡®°„‚†
					SendDlgItemMessage (
						hwnd, IDD_PROP, LB_GETTEXT,
                        SendDlgItemMessage ( hwnd, IDD_PROP, LB_GETCURSEL, 0, 0L ),
						(DWORD) Name
						);
					// ì·‚†≠Æ¢®‚Ï ®·ÂÆ§≠„Ó ·Æ‡‚®‡Æ¢™„
					pData->KBase->SetAttSort ( PrevSort );

					if ( SendDlgItemMessage ( hwnd, IDD_PREMISE, BM_GETCHECK, 0, 0L ) )
						FullPath[0] = IDD_PREMISE;
					else
						FullPath[0] = IDD_CONCLUSION;

					// éØ‡•§•´®‚Ï ØÆ ®¨•≠® ≠Æ¨•‡ †‚‡®°„‚†
					EndDialog ( hwnd, pData->KBase->Name2Att ( Name ) );
					break;
					}
				case IDCANCEL : {
					pData->KBase->SetAttSort ( PrevSort );
					EndDialog ( hwnd, -1 );
					break;
					}
				case IDD_UNSORTED : {
					pData->FillPropositions ( hwnd );
					break;
					}
				case IDD_NAME : {
					pData->FillPropositions ( hwnd );
					break;
					}
				case IDD_PRICE : {
					pData->FillPropositions ( hwnd );
					break;
					}
				case IDD_IMPORTANCE : {
					pData->FillPropositions ( hwnd );
					break;
					}
				case IDD_VALNUM : {
					pData->FillPropositions ( hwnd );
					break;
					}
				case IDD_REVERSE : {
					pData->FillPropositions ( hwnd );
					break;
					}
				default:
					return FALSE;
				}
		    break;
			}
		default :
			return FALSE ;
		}
	return TRUE;
	}

/*
⁄ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒ¬ƒƒƒƒƒƒƒƒƒƒƒƒƒø
≥                                                              ≥ DataWndProc ≥
≥                                                              ¿ƒƒƒƒƒƒƒƒƒƒƒƒƒ¥
¿ƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒƒŸ
*/
long FAR PASCAL _export DataWndProc ( HWND hwnd, UINT msg, WPARAM wParam, LPARAM lParam ) {

	LPDATA tis = (LPDATA) GetMem ( hwnd );

    switch ( msg ) {

		case WM_GETMINMAXINFO  : {
			((LPPOINT) lParam)[3].x = 64;
			((LPPOINT) lParam)[3].y = 64;
			break;
			}
		case WM_CREATE         : {
			SetMem ( hwnd, (LPVOID) ( (LPMDICREATESTRUCT) ( (LPCREATESTRUCT) lParam )->lpCreateParams )->lParam );
			break;
			}
		case WM_MEASUREITEM    : {
			// é§®≠†™Æ¢†Ô ¢Î·Æ‚† §´Ô †‚‡®°„‚Æ¢ ® ß≠†Á•≠®©
			((LPMEASUREITEMSTRUCT) lParam) -> itemHeight = Frame.LBitemHight;
			break;
			}
		case WM_DRAWITEM       : {
			tis->DrawItem ( (LPDRAWITEMSTRUCT) lParam );
			break;
			}
		case WM_MDIACTIVATE    : {
			if ( wParam == TRUE ) {
				// á†£‡„ß®‚Ï ·ÆÆ‚¢•‚·‚¢„ÓÈ•• ¨•≠Ó, †™·•´•‡†‚Æ‡ ® ™„‡·Æ‡
				SendMessage ( Frame.hwndClient, WM_MDISETMENU, FALSE, MAKELONG ( DATA::hMenu, DATA::hWndMenu ) );
				Frame.hAccel = DATA::hAccel;
				if ( tis->SplitState == IDM_VIEWHORIZONTAL )
					SetClassWord ( hwnd, GCW_HCURSOR, DATA::HorCur );
				else
					SetClassWord ( hwnd, GCW_HCURSOR, DATA::VerCur );
				Frame.hwndActive = hwnd;
//				tis->SetFocus ( );
			}
			if ( wParam == FALSE ) {
				// á†£‡„ß®‚Ï ‰‡•©¨Æ¢Î• ¨•≠Ó ® †™·•´•‡†‚Æ‡ (Ø‡® Æ‚·„‚·‚¢®® Æ™Æ≠)
				SendMessage ( Frame.hwndClient, WM_MDISETMENU, FALSE, MAKELONG ( Frame.FrmMenu, Frame.WndMenu ) );
				Frame.hAccel = Frame.hFrmAccel;
				Frame.hwndActive = 0;
				}
			DrawMenuBar ( Frame.hwndFrame );
			break;
			}
		case WM_SETFOCUS : {
			tis->SetFocus();
			break;
			}
		case WM_INITMENU : {
			tis->InitMenu();
			break;
			}
		case WM_SIZE     : {
			tis->Size ( wParam, lParam );
			break;
			}
		case WM_LBUTTONDOWN : {
			tis->PartMove ( WM_LBUTTONDOWN, lParam );
			break;
			}
		case WM_MOUSEMOVE : {
			tis->PartMove ( WM_MOUSEMOVE, lParam );
			break;
			}
		case WM_LBUTTONUP : {
			tis->PartMove ( WM_LBUTTONUP, lParam );
			break;
			}
		case WM_COMMAND : {
			switch( wParam ) {
				case CHANGE_TITLE    : {
					char buf[80];
					if ( tis->KBase->GetView() == VIEW_DATA ) lstrcpy ( buf, TITLE_DATA );
					else                                      lstrcpy ( buf, TITLE_CONC );
					lstrcat ( buf, tis->KBase->GetNamePtr() );
					SetWindowText ( hwnd, buf );
					break;
					}
				case CHANGE_COMPONENT: {
					// àß¨•≠®´†·Ï ™Æ¨ØÆ≠•≠‚† †‚‡®°„‚† LOWORD(lParam) ® ß≠†Á•≠®Ô HIWORD(lParam)
					tis->ChangeComponent ( LOWORD(lParam), HIWORD(lParam) );
					break;
					}
				case CHANGE_CONTENT  :
				case PUT_ATTRIBUTE   :         // åÆ£´Æ ®ß¨•≠®‚Ï·Ô ≠†ß¢†≠®• ® ·Æ‡‚®‡Æ¢™†
//				case INS_ATTRIBUTE   :                             // ç• ≠„¶≠Æ
				case DEL_ATTRIBUTE   :         // åÆ¶•‚ ®·Á•ß≠„‚Ï ¢Î·™†ßÎ¢†≠®•
				case PUT_VALUE       :         // åÆ¶•‚ ®ß¨•≠®‚Ï·Ô ≠†ß¢†≠®• ® ·Æ‡‚®‡Æ¢™†
				case INS_VALUE       :       // åÆ¶•‚ ØÆÔ¢®‚Ï·Ô ≠Æ¢Æ• ß≠†Á•≠®•
				case DEL_VALUE       :             // åÆ¶•‚ ®·Á•ß≠„‚Ï ß≠†Á•≠®•
//				case INS_RULE        :                      // ç• ®·ØÆ´Ïß„•‚·Ô
				case DEL_RULE        :
				case INS_PROP        :
				case DEL_PROP        :
				case INVERT_PROP     : {
					tis->PrintOn();
					break;
					}
				case IDM_CHANGEWINDOW: {
					tis->ChangeWin();
					break;
					}
				case IDM_FILESAVE       : {
					tis->Save();
					break;
					}
				case IDM_FILESAVEAS     : {
					if ( FileSaveAs() ) {
						tis->KBase->RenameKBase ( FullPath );
						if ( LKE_SUCCESS != tis->KBase->SaveKBase() ) ErrorMessager ( 0, MB_OK | MB_ICONHAND | MB_SYSTEMMODAL, IDS_CANTSAVE );
						}
					break;
					}
				case IDM_VIEWHORIZONTAL : {
					tis->View ( IDM_VIEWHORIZONTAL );
					break;
					}
				case IDM_VIEWVERTICAL   : {
					tis->View ( IDM_VIEWVERTICAL );
					break;
					}
				case IDM_ASINRULE       : {         // é‚ Ø„≠™‚† ¨•≠Ó Unsorted
					if ( tis->isAttSelected() )
						if ( tis->KBase->GetAttSort() > 0 ) tis->KBase->SetAttSort ( SORT_ASINRULE );
						else                                tis->KBase->SetAttSort ( - SORT_ASINRULE );
					else ;                // Ñ´Ô ß≠†Á•≠®© ‚†™Æ© ·Æ‡‚®‡Æ¢™® ≠•‚
					tis->PrintOn();
					break;
					}
				case IDM_UNSORTED       : {        // é‚ Ø„≠™‚† ¨•≠Ó Structure
					if ( tis->isAttSelected() )
						if ( tis->KBase->GetAttSort() > 0 ) tis->KBase->SetAttSort ( SORT_UNSORTED );
						else                                tis->KBase->SetAttSort ( - SORT_UNSORTED );
					else
						if ( tis->KBase->GetValSort() > 0 ) tis->KBase->SetValSort ( SORT_UNSORTED );
						else                                tis->KBase->SetValSort ( - SORT_UNSORTED );
					tis->PrintOn();
					break;
					}
				case IDM_NAME           : {
					if ( tis->isAttSelected() )
						if ( tis->KBase->GetAttSort() > 0 ) tis->KBase->SetAttSort ( SORT_ALPHA );
						else                                tis->KBase->SetAttSort ( - SORT_ALPHA );
					else
						if ( tis->KBase->GetValSort() > 0 ) tis->KBase->SetValSort ( SORT_ALPHA );
						else                                tis->KBase->SetValSort ( - SORT_ALPHA );
					tis->PrintOn();
					break;
					}
				case IDM_PRICE          : {
					if ( tis->isAttSelected() )
						if ( tis->KBase->GetAttSort() > 0 ) tis->KBase->SetAttSort ( SORT_PRICE );
						else                                tis->KBase->SetAttSort ( - SORT_PRICE );
					else
						if ( tis->KBase->GetValSort() > 0 ) tis->KBase->SetValSort ( SORT_PRICE );
						else                                tis->KBase->SetValSort ( - SORT_PRICE );
					tis->PrintOn();
					break;
					}
				case IDM_IMPORTANCE     : {
					if ( tis->isAttSelected() )
						if ( tis->KBase->GetAttSort() > 0 ) tis->KBase->SetAttSort ( SORT_IMPORTANCE );
						else                                tis->KBase->SetAttSort ( - SORT_IMPORTANCE );
					else
						if ( tis->KBase->GetValSort() > 0 ) tis->KBase->SetValSort ( SORT_IMPORTANCE );
						else                                tis->KBase->SetValSort ( - SORT_IMPORTANCE );
					tis->PrintOn();
					break;
					}
				case IDM_VALUES         : {
					if ( tis->isAttSelected() )
						if ( tis->KBase->GetAttSort() > 0 ) tis->KBase->SetAttSort ( SORT_VALNUM );
						else                                tis->KBase->SetAttSort ( - SORT_VALNUM );
					else ;                // Ñ´Ô ß≠†Á•≠®© ‚†™Æ© ·Æ‡‚®‡Æ¢™® ≠•‚
					tis->PrintOn();
					break;
					}
				case IDM_CHARACTER      : {
					if ( tis->isValSelected() )
						if ( tis->KBase->GetValSort() > 0 ) tis->KBase->SetValSort ( SORT_CHARACTER );
						else                                tis->KBase->SetValSort ( - SORT_CHARACTER );
					else ;               // Ñ´Ô †‚‡®°„‚Æ¢ ‚†™Æ© ·Æ‡‚®‡Æ¢™® ≠•‚
					tis->PrintOn();
					break;
					}
				case IDM_REVERSE        : {
					if ( tis->isAttSelected() )
						tis->KBase->SetAttSort ( - tis->KBase->GetAttSort() );
					else
						tis->KBase->SetValSort ( - tis->KBase->GetValSort() );
					tis->PrintOn();
					break;
					}
				case IDM_VIEWDATA  : {
					tis->KBase->SetView ( VIEW_DATA );
					SendMessage ( hwnd, WM_COMMAND, CHANGE_TITLE, 0L );
					tis->PrintOn();
					break;
					}
				case IDM_VIEWCONCLUSION  : {
					tis->KBase->SetView ( VIEW_CONCLUSION );
					SendMessage ( hwnd, WM_COMMAND, CHANGE_TITLE, 0L );
					tis->PrintOn();
					break;
					}
				case IDM_INFERENCE  : {
					int Error = tis->KBase->InferenceCNF();
					if ( Error == LKE_NOTCOMPILED ) {
						ErrorMessager  ( Frame.hwndFrame, MB_OK | MB_ICONHAND | MB_APPLMODAL, IDS_NOTCOMPILED );
						}
					else if ( Error == LKE_NOGOAL ) {
						ErrorMessager  ( Frame.hwndFrame, MB_OK | MB_ICONHAND | MB_APPLMODAL, IDS_NOGOAL );
						}
					else if ( Error == LKE_SUCCESS ) {
						MessageBeep ( -1 );
						}
//					SendMessage ( hwnd, WM_COMMAND, IDM_VIEWCONCLUSION, 0 );
					break;
					}
				case IDM_ITEMADD        : {
					if ( tis->isAttSelected() ) tis->InsertProposition();
					else                        tis->InsertValue();
					tis->SetFocus();
					break;
					}
				case IDM_ITEMINVERT       : {
					if ( tis->isAttSelected() ) tis->InvertProposition();
					else                        tis->EditValue();
					tis->SetFocus();
					break;
					}
				case IDM_ITEMDELETE     : {
					if ( tis->isAttSelected() ) tis->DeleteProposition();
					else                        tis->DeleteValue();
					tis->SetFocus();
					break;
					}
				case IDM_INCREASE  : {
					tis->IncreaseComp();
					break;
					}
				case IDM_DECREASE  : {
					tis->DecreaseComp();
					break;
					}
				case IDM_HYPERTEXT  : {
					MOD_DESCR md;
					tis->KBase->GetModuleHead ( & md );
					if ( md.HyperFile[0] == 0 ) {
						ErrorMessager  ( 0, MB_OK | MB_ICONHAND | MB_APPLMODAL, IDS_NOHYPERFILE );
						break;
						}

					ATT_REC ar;
					VAL_REC vr;
					DWORD idx;
					int Att = tis->KBase->GetCurAtt();
					int Val = tis->KBase->GetCurVal();
					if ( tis->isAttSelected() ) {
						if (  Att != -1 && Att != tis->KBase->AttNumber() ) {
							tis->KBase->GetAttribute ( Att, & ar );
							idx = ar.HyperIndex;
							}
						else break;
						}
					else if ( tis->isValSelected() ) {
						if ( Val != -1 && Val != tis->KBase->ValNumber ( Att ) ) {
							tis->KBase->GetValue ( Att, Val, & vr );
							idx = vr.HyperIndex;
							}
						else break;
						}
					else break;
					if ( idx == 0 ) {
						ErrorMessager  ( 0, MB_OK | MB_ICONHAND | MB_APPLMODAL, IDS_NOINDEX );
						break;
						}
					WinHelp ( hwnd, md.HyperFile, HELP_CONTEXT, idx );
					break;
					}
				case IDM_ATT_LISTBOX    : {
					if ( HIWORD ( lParam ) == LBN_DBLCLK ) {
						if ( tis->SplitState != IDM_VIEWNONE )
							if ( tis->KBase->GetCurAtt() != tis->KBase->AttNumber() )
								SendMessage ( hwnd, WM_COMMAND, IDM_ITEMINVERT, 0L );
							else SendMessage ( hwnd, WM_COMMAND, IDM_ITEMADD, 0L );
						else
							if ( tis->KBase->GetCurVal() == -1 )
								if ( tis->KBase->GetCurAtt() != tis->KBase->AttNumber() )
									SendMessage ( Frame.hwndFrame, WM_COMMAND, IDM_ITEMINVERT, 0L );
								else SendMessage ( Frame.hwndFrame, WM_COMMAND, IDM_ITEMADD, 0L );
							else if ( tis->KBase->GetCurVal() != tis->KBase->ValNumber ( tis->KBase->GetCurAtt() ) )
									SendMessage ( Frame.hwndFrame, WM_COMMAND, IDM_ITEMEDIT, 0L );
						break;
						}
					if ( HIWORD ( lParam ) == LBN_SETFOCUS ) {
						if ( tis->SplitState != IDM_VIEWNONE )
							tis->CurFocus = IDM_ATT_LISTBOX;
						break;
						}
					if ( HIWORD ( lParam ) == LBN_SELCHANGE ) {
						int idx = SendMessage ( LOWORD(lParam), LB_GETCURSEL, 0, 0L);
						if ( tis->SplitState == IDM_VIEWNONE ) {
							tis->KBase->SetCurAtt ( tis->NoneIdx2Att ( idx ) );
							tis->KBase->SetCurVal ( tis->NoneIdx2Val ( idx ) );
							}
						else if ( idx != tis->KBase->GetCurAttPos() ) {
							tis->KBase->SetCurAttPos ( idx );
							tis->KBase->SetCurVal ( -1 );
							tis->FillValListBox ( tis->KBase->GetCurAtt() );
							}
						break;
						}
					break;
					}
				case IDM_VAL_LISTBOX    : {
					if ( HIWORD ( lParam ) == LBN_DBLCLK ) {
                        if ( tis->SplitState != IDM_VIEWNONE )
							if ( tis->KBase->GetCurVal() != tis->KBase->ValNumber ( tis->KBase->GetCurAtt() ) )
								SendMessage ( Frame.hwndFrame, WM_COMMAND, IDM_ITEMEDIT, 0L );
						break;
						}
					if ( HIWORD ( lParam ) == LBN_SETFOCUS ) {
						if ( tis->SplitState != IDM_VIEWNONE )
							tis->CurFocus = IDM_VAL_LISTBOX;
						break;
						}
					if ( HIWORD ( lParam ) == LBN_SELCHANGE ) {
						int idx = SendMessage ( LOWORD ( lParam ), LB_GETCURSEL, 0, 0L);
						if ( tis->SplitState != IDM_VIEWNONE ) {    // !!! à ≠• ¨Æ¶•‚ °Î‚Ï ‡†¢≠Æ
							tis->KBase->SetCurVal ( idx );
							}
						break;
						}
					break;
					}

				default : goto CallDCP;
				}
			break;
			}

		case WM_CLOSE   : {
			if ( tis->Close ( ) ) {              // Ö·´® §•©·‚¢®‚•´Ï≠Æ ß†™‡Î´®
				goto CallDCP;                                  // á†™‡Î‚Ï Æ™≠Æ
				}
			break;
			}

		default :
CallDCP:
			return DefMDIChildProc ( hwnd, msg, wParam, lParam );
		}
	return FALSE;
	}
















